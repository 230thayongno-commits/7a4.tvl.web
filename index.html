<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>7A4 GALAXY COMMAND</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    /* =========================
       VARIABLES & THEMES
       ========================= */
    :root{
      --primary: #00f3ff;
      --secondary: #bc13fe;
      --accent: #ff0055;
      --success: #00ff9d;
      --glass: rgba(255,255,255,0.06);
      --glass-border: rgba(255,255,255,0.12);
      --bg1: #05060b;
      --bg2: #0a0f1f;
      --text: #eaeaea;
    }

    body[data-theme="galaxy"]{
      --primary: #00f3ff;
      --secondary: #bc13fe;
      --accent: #ff0055;
      --success: #00ff9d;
      --bg1: #05060b;
      --bg2: #0a0f1f;
      --glass: rgba(255,255,255,0.06);
      --glass-border: rgba(255,255,255,0.12);
      --text: #eaeaea;
    }

    /* T·∫æT THEME: ƒë·ªè + v√†ng, vi·ªÅn v√†ng, m√†u m√® h∆°n */
    body[data-theme="tet"]{
      --primary: #ffcc33;      /* v√†ng */
      --secondary: #ff4d4d;    /* ƒë·ªè */
      --accent: #ff2d8a;       /* h·ªìng */
      --success: #4dff88;
      --bg1: #1a0606;
      --bg2: #3a0b06;
      --glass: rgba(255,255,255,0.06);
      --glass-border: rgba(255, 210, 80, 0.25);
      --text: #fff3d6;
    }

    html,body{ height:100%; margin:0; font-family:'Montserrat',sans-serif; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    body{
      background: radial-gradient(circle at top, var(--bg2), var(--bg1));
      color: var(--text);
      overflow-x:hidden;
    }

    /* ensure theme backgrounds override anything else */
    html, body { background: radial-gradient(circle at top, var(--bg2), var(--bg1)) !important; color: var(--text) !important; }

    /* ===== toast ===== */
    #toast {
      position: fixed; top: 16px; left: 50%; transform: translateX(-50%); z-index: 99999;
      background: rgba(0,0,0,0.7); color: #fff; padding: 10px 18px; border-radius: 12px; font-weight:800;
      opacity: 0; pointer-events:none; transition: 220ms; border:1px solid rgba(255,255,255,0.06);
      backdrop-filter:blur(6px);
    }
    #toast.show { opacity:1; pointer-events:auto; }

    /* basic animations */
    @keyframes fadeUp { from { opacity:0; transform: translateY(12px); } to { opacity:1; transform:translateY(0); } }
    .animate-in { animation: fadeUp .55s ease both; }

    /* =========================
       SELECTOR SCREEN
       ========================= */
    #selector-screen{
      position:fixed; inset:0; display:flex; flex-direction:column; justify-content:center; align-items:center; gap:14px;
      z-index: 50; padding:20px;
    }
    /* different backgrounds per theme (selector) */
    body[data-theme="galaxy"] #selector-screen {
      background: radial-gradient(circle at 30% 20%, rgba(0,243,255,0.05), transparent 12%),
                  radial-gradient(circle at 80% 80%, rgba(188,19,254,0.03), transparent 15%);
    }
    body[data-theme="tet"] #selector-screen {
      background: linear-gradient(180deg, rgba(255,80,60,0.04), rgba(0,0,0,0.06)), radial-gradient(circle at 50% 30%, rgba(255,200,50,0.06), transparent 12%);
    }

    .hero-title {
      font-weight:900; font-size: clamp(1.6rem, 6vw, 3.0rem); text-align:center; letter-spacing: 1px;
      color: var(--primary); text-shadow: 0 8px 30px rgba(0,0,0,0.4);
    }
    .subtitle { color: rgba(255,255,255,0.7); font-weight:700; letter-spacing:2px; font-size:0.78rem; }

    .team-grid { margin-top: 22px; width:100%; max-width:520px; display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
    .team-card {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:14px; padding:14px; text-align:center; font-weight:900; cursor:pointer; border:1px solid var(--glass-border);
      transition: transform .18s, box-shadow .18s;
      user-select:none;
      backdrop-filter: blur(8px);
    }
    .team-card:hover{ transform: translateY(-4px); box-shadow: 0 16px 40px rgba(0,0,0,0.35); }

    /* T·∫øt accent on team card: golden border */
    body[data-theme="tet"] .team-card { border: 1px solid rgba(255,210,80,0.25); box-shadow: 0 12px 30px rgba(255,80,60,0.05); }

    /* =========================
       HEADER / APP
       ========================= */
    header {
      position: sticky; top:0; z-index:60; display:flex; justify-content:space-between; align-items:center; padding:14px 18px;
      background: linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.12)); border-bottom: 1px solid rgba(255,255,255,0.04);
      backdrop-filter: blur(8px);
    }
    .container { max-width:1000px; margin:0 auto; padding:18px; }

    /* admin & settings */
    #user-info { display:flex; align-items:center; gap:12px; }

    button[disabled]{ opacity:0.6; cursor:not-allowed; }

    /* =========================
       RANK CARD / MISSION GRID
       ========================= */
    .rank-card{ background:rgba(255,255,255,0.03); border-radius:18px; padding:16px; border:1px solid var(--glass-border); }
    .mission-grid{ display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:14px; margin-top:18px; }

    .mission-card{ padding:16px; border-radius:14px; cursor:pointer; border:1px solid var(--glass-border); background:rgba(255,255,255,0.02); }
    .mission-card:hover{ transform:translateY(-4px); box-shadow: 0 20px 50px rgba(0,0,0,0.28); transition: .18s; }

    /* =========================
       GAME OVERLAY
       ========================= */
    #game-overlay { position:fixed; inset:0; display:none; z-index:9998; background: rgba(0,0,0,0.6); padding:18px; align-items:stretch; justify-content:center; }
    .game-header{ display:flex; justify-content:space-between; align-items:center; padding:12px; margin-bottom:12px; }
    .game-container-box{ max-width:820px; margin:0 auto; }

    .question-card{ padding:18px; border-radius:20px; border:1px solid var(--glass-border); background:rgba(255,255,255,0.02); }

    .mini-rank-grid { display:grid; grid-template-columns: repeat(2,1fr); gap:8px; margin-bottom:12px; }
    .mini-rank-item { padding:8px 12px; border-radius:12px; background: rgba(255,255,255,0.03); display:flex; justify-content:space-between; font-weight:900; }

    /* =========================
       ADMIN PANEL (inserted markup below will be shown/hidden)
       ========================= */
    #admin-panel {
      position: fixed; right: 20px; top: 80px; background: rgba(3,7,18,0.95); backdrop-filter: blur(12px);
      border-radius: 16px; z-index: 99999; width: 340px; padding:14px; display:none; border:1px solid var(--glass-border);
      max-height: 75vh; overflow-y:auto; box-shadow: 0 30px 90px rgba(0,0,0,0.6);
    }
    /* mobile placement */
    @media (max-width:600px){
      #admin-panel{ left:50%; right:auto; transform:translateX(-50%); width:92%; bottom:20px; top:auto; max-height:60vh; border-radius:18px; }
    }

    /* =========================
       T·∫æT DECOR: hoa mai + fireworks canvas
       ========================= */
    .hoa-mai {
      position: absolute; width: 120px; height: 120px; pointer-events:none; z-index: 40; opacity: 0.95;
      transform-origin: center;
      will-change: transform;
    }
    .hoa-mai svg{ width:100%; height:100%; display:block; }
    /* small sway */
    .sway { animation: sway 4s ease-in-out infinite; }
    @keyframes sway {
      0%{ transform: translateY(0) rotate(-2deg); }
      50%{ transform: translateY(4px) rotate(2deg); }
      100%{ transform: translateY(0) rotate(-2deg); }
    }

    /* fireworks canvas over everything (only visible when used) */
    #fireworks-canvas {
      position: fixed; inset:0; z-index: 999999; pointer-events:none; display:none;
    }

    /* small utility */
    .hidden{ display:none !important; }
  </style>
</head>

<body data-theme="galaxy">
  <div id="toast">Th√¥ng b√°o</div>

  <!-- hoa mai elements (will show for T·∫øt theme) -->
  <div id="hoa-mai-1" class="hoa-mai hidden sway" style="left:10px; top:40px;">
    <!-- simple flower svg (5 petals) -->
    <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
      <g transform="translate(50,50)">
        <circle r="6" fill="#ffcc33"></circle>
        <g fill="#ff4d4d" transform="rotate(0) translate(22,0)">
          <ellipse rx="12" ry="6"></ellipse>
        </g>
        <g fill="#ff4d4d" transform="rotate(72) translate(22,0)"><ellipse rx="12" ry="6"></ellipse></g>
        <g fill="#ff4d4d" transform="rotate(144) translate(22,0)"><ellipse rx="12" ry="6"></ellipse></g>
        <g fill="#ff4d4d" transform="rotate(216) translate(22,0)"><ellipse rx="12" ry="6"></ellipse></g>
        <g fill="#ff4d4d" transform="rotate(288) translate(22,0)"><ellipse rx="12" ry="6"></ellipse></g>
      </g>
    </svg>
  </div>

  <div id="hoa-mai-2" class="hoa-mai hidden sway" style="right:12px; top:80px; transform-origin:center;">
    <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
      <g transform="translate(50,50)">
        <circle r="6" fill="#ffcc33"></circle>
        <g fill="#ff2d8a" transform="rotate(0) translate(22,0)"><ellipse rx="11" ry="5.5"></ellipse></g>
        <g fill="#ff2d8a" transform="rotate(72) translate(22,0)"><ellipse rx="11" ry="5.5"></ellipse></g>
        <g fill="#ff2d8a" transform="rotate(144) translate(22,0)"><ellipse rx="11" ry="5.5"></ellipse></g>
        <g fill="#ff2d8a" transform="rotate(216) translate(22,0)"><ellipse rx="11" ry="5.5"></ellipse></g>
        <g fill="#ff2d8a" transform="rotate(288) translate(22,0)"><ellipse rx="11" ry="5.5"></ellipse></g>
      </g>
    </svg>
  </div>

  <!-- FIREWORKS CANVAS -->
  <canvas id="fireworks-canvas"></canvas>

  <!-- M√ÄN H√åNH CH·ªåN T·ªî -->
  <div id="selector-screen">
    <div class="hero-title animate-in">7A4 GALAXY<br>COMMAND</div>
    <p class="subtitle animate-in">H·ªÜ TH·ªêNG √îN T·∫¨P HK2</p>

    <div class="team-grid animate-in" style="animation-delay:0.1s;">
      <div class="team-card" onclick="galaxy.selectTeam('T·ªï 1')" style="color: var(--primary)">T·ªï 1</div>
      <div class="team-card" onclick="galaxy.selectTeam('T·ªï 2')" style="color: var(--secondary)">T·ªï 2</div>
      <div class="team-card" onclick="galaxy.selectTeam('T·ªï 3')" style="color: var(--accent)">T·ªï 3</div>
      <div class="team-card" onclick="galaxy.selectTeam('T·ªï 4')" style="color: var(--success)">T·ªï 4</div>
    </div>
  </div>

  <!-- APP CH√çNH -->
  <div id="main-app" class="hidden">
    <header>
      <div style="font-weight:900; letter-spacing:1px; font-size:1.05rem;">7A4 COMMAND</div>
      <div id="user-info">
        <span id="team-tag" style="font-weight:900; background:var(--primary); color:#000; padding:6px 10px; border-radius:8px; font-size:0.85rem;"></span>

        <!-- Style button -->
        <button onclick="galaxy.openStyleSettings()" style="background:none; border:none; color:var(--text); font-weight:800; cursor:pointer;">üé® Style</button>

        <button onclick="galaxy.logout()" style="background:none; border:none; color:#aaa; font-weight:bold; cursor:pointer;">THO√ÅT</button>

        <!-- ADMIN button -->
        <button id="admin-btn" onclick="galaxy.toggleAdminPrompt()" style="background:none; border:none; color:var(--text); font-weight:700; cursor:pointer;">Admin</button>
      </div>
    </header>

    <div class="container animate-in">
      <div class="rank-card">
        <h2 style="margin:0; font-size:1.05rem; text-align:center; color:var(--primary); text-transform:uppercase; letter-spacing:2px;">ƒêi·ªÉm S·ªë Chi·∫øn ƒê·ªôi</h2>
        <div id="ranking-list" style="margin-top:12px;"></div>
        <div id="prev-winner" style="margin-top:12px; font-weight:800; text-align:center; color:#ddd;"></div>
        <div style="margin-top:12px; color:#aaa; font-weight:700; font-size:0.85rem; text-align:center;">‚è∞ H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông reset ƒëi·ªÉm v√†o m·ªói <strong>Ch·ªß nh·∫≠t 12:00</strong></div>
      </div>

      <div class="mission-grid">
        <div class="mission-card" onclick="englishGame.start()">
          <div style="font-size:1.6rem">üá¨üáß</div>
          <div style="font-weight:900; margin-top:6px;">Ti·∫øng Anh HK2</div>
          <div style="color:#ccc; margin-top:6px;">100+ c√¢u h·ªèi Vocabulary, Adverbs, How structure, Ability.</div>
        </div>

        <div class="mission-card" onclick="mathGame.start()">
          <div style="font-size:1.6rem">üìê</div>
          <div style="font-weight:900; margin-top:6px;">To√°n H·ªçc</div>
          <div style="color:#ccc; margin-top:6px;">C·ªông tr·ª´, nh√¢n chia, t√¨m x, s·ªë m≈©.</div>
        </div>

        <div class="mission-card locked">
          <div style="font-size:1.6rem">üß™</div>
          <div style="font-weight:900; margin-top:6px;">KHTN</div>
          <div style="color:#ccc; margin-top:6px;">S·∫Øp c√≥</div>
        </div>
      </div>

      <footer style="margin-top:28px; text-align:center; color:#888;">*N·∫øu web c√≥ l·ªói ho·∫∑c c√¢u h·ªèi sai xin li√™n h·ªá admin t·∫°i 2 trang tiktok c·ªßa l·ªõp.</footer>
    </div>
  </div>

  <!-- SETTINGS OVERLAY -->
  <div id="style-overlay" class="hidden" style="position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:99997;">
    <div style="width:min(560px,96%); background:rgba(0,0,0,0.6); border-radius:16px; padding:16px; border:1px solid var(--glass-border);">
      <div style="font-weight:900; color:var(--primary); margin-bottom:8px;">C√†i ƒë·∫∑t phong c√°ch game</div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <div style="padding:12px; border-radius:12px; background:rgba(255,255,255,0.02); cursor:pointer;" onclick="galaxy.setTheme('galaxy')">
          <div style="font-weight:900;">üåå Galaxy</div>
          <div style="color:#bbb; font-weight:700; margin-top:6px;">Phong c√°ch g·ªëc: neon, l·∫°nh, v≈© tr·ª•.</div>
        </div>
        <div style="padding:12px; border-radius:12px; background:rgba(255,255,255,0.02); cursor:pointer;" onclick="galaxy.setTheme('tet')">
          <div style="font-weight:900;">üßß T·∫øt</div>
          <div style="color:#bbb; font-weight:700; margin-top:6px;">ƒê·ªè - v√†ng, hoa mai, ph√°o hoa khi b·∫•m.</div>
        </div>
      </div>
      <div style="display:flex; justify-content:flex-end; margin-top:12px;">
        <button class="btn-confirm small" onclick="galaxy.closeStyleSettings()" style="background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.08);">ƒê√≥ng</button>
      </div>
    </div>
  </div>

  <!-- ADMIN PANEL (restored & improved) -->
  <div id="admin-panel" class="hidden" aria-hidden="true">
    <div style="font-size:1.05rem; margin-bottom:12px; text-align:center; color:var(--primary); text-transform:uppercase; font-weight:900;">Admin Tools</div>

    <div style="font-weight:800; color:#aaa; margin-bottom:6px;">Nh·∫≠p ƒëi·ªÉm (+/-)</div>
    <input id="admin-point-input" type="number" placeholder="V√≠ d·ª•: 10 ho·∫∑c -5" style="width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background:rgba(0,0,0,0.35); color:#fff; margin-bottom:10px;">

    <div style="font-weight:800; color:#aaa; margin-bottom:6px;">√Åp d·ª•ng cho</div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:12px;">
      <button class="btn-confirm small" onclick="adminApplyInput('to1')" style="background: rgba(0, 243, 255, 0.12); border:1px solid var(--primary); color:var(--primary);">T·ªï 1</button>
      <button class="btn-confirm small" onclick="adminApplyInput('to2')" style="background: rgba(188, 19, 254, 0.12); border:1px solid var(--secondary); color:var(--secondary);">T·ªï 2</button>
      <button class="btn-confirm small" onclick="adminApplyInput('to3')" style="background: rgba(255, 0, 85, 0.12); border:1px solid var(--accent); color:var(--accent);">T·ªï 3</button>
      <button class="btn-confirm small" onclick="adminApplyInput('to4')" style="background: rgba(0, 255, 157, 0.12); border:1px solid var(--success); color:var(--success);">T·ªï 4</button>
    </div>

    <div style="font-weight:800; color:#aaa; margin-bottom:6px;">N√∫t nhanh (+/-1)</div>
    <div style="display:flex; flex-direction:column; gap:8px; margin-bottom:12px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="font-weight:900; color:var(--primary)">T·ªï 1</div>
        <div style="display:flex; gap:6px;">
          <button class="btn-confirm small" onclick="adminAdjust('to1',1)">+1</button>
          <button class="btn-confirm small" style="background:#444;" onclick="adminAdjust('to1',-1)">-1</button>
        </div>
      </div>
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="font-weight:900; color:var(--secondary)">T·ªï 2</div>
        <div style="display:flex; gap:6px;">
          <button class="btn-confirm small" onclick="adminAdjust('to2',1)">+1</button>
          <button class="btn-confirm small" style="background:#444;" onclick="adminAdjust('to2',-1)">-1</button>
        </div>
      </div>
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="font-weight:900; color:var(--accent)">T·ªï 3</div>
        <div style="display:flex; gap:6px;">
          <button class="btn-confirm small" onclick="adminAdjust('to3',1)">+1</button>
          <button class="btn-confirm small" style="background:#444;" onclick="adminAdjust('to3',-1)">-1</button>
        </div>
      </div>
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="font-weight:900; color:var(--success)">T·ªï 4</div>
        <div style="display:flex; gap:6px;">
          <button class="btn-confirm small" onclick="adminAdjust('to4',1)">+1</button>
          <button class="btn-confirm small" style="background:#444;" onclick="adminAdjust('to4',-1)">-1</button>
        </div>
      </div>
    </div>

    <div style="font-weight:800; color:#aaa; margin-bottom:6px;">H·ªá th·ªëng</div>
    <div style="display:grid; gap:8px;">
      <button class="btn-confirm small" onclick="adminUndo()" style="background:#888;">‚Ü© HO√ÄN T√ÅC</button>
      <button class="btn-confirm small" onclick="adminResetScores()" style="background: #ffcc33; color:#000;">‚ö† RESET ƒêI·ªÇM (ALL)</button>
      <button class="btn-confirm small" onclick="galaxy.logoutAdmin()" style="background:#ff5a5a; color:#fff;">ƒêƒÉng xu·∫•t</button>
    </div>
  </div>

  <!-- GAME OVERLAY -->
  <div id="game-overlay" class="hidden">
    <div class="game-header">
      <div id="game-label" style="font-weight:900; color:var(--primary);">MISSION</div>
      <button class="btn-exit" onclick="galaxy.closeGame()">THO√ÅT ‚úï</button>
    </div>
    <div class="game-container-box">
      <div id="mini-rank-list" class="mini-rank-grid"></div>
      <div class="question-card">
        <div id="q-tag" class="q-tag">Ki·∫øn th·ª©c HK2</div>
        <div id="game-content-area" style="width:100%; display:flex; flex-direction:column; align-items:center;">
          <div id="q-text" class="q-text">ƒêang t·∫£i c√¢u h·ªèi.</div>
          <div id="q-action" style="width:100%;"></div>
        </div>
        <div id="q-feedback" style="margin-top:12px; text-align:center; font-weight:800;"></div>
      </div>
    </div>
  </div>

  <!-- FIREWORKS CANVAS (kept in DOM) -->
  <canvas id="fireworks-canvas"></canvas>

  <!-- SCRIPT (KEEP your Firebase code + game logic intact; only added theme/admin UI handlers + fireworks) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, getDocs,
      writeBatch, increment
    } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBtdoU4bzBVsXXvYswbUf0smAuYIq9rxlM",
      authDomain: "a4-galaxy-command.firebaseapp.com",
      projectId: "a4-galaxy-command",
      storageBucket: "a4-galaxy-command.firebasestorage.app",
      messagingSenderId: "147400399283",
      appId: "1:147400399283:web:6d470d3e02a94e01f053c6",
      measurementId: "G-678SMH2ND5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const ADMIN_PASSWORD = "emyeudang";

    const DOC_TO_TEAM = {
      to1: { id: "T·ªï 1", color: "#00f3ff" },
      to2: { id: "T·ªï 2", color: "#bc13fe" },
      to3: { id: "T·ªï 3", color: "#ff0055" },
      to4: { id: "T·ªï 4", color: "#00ff9d" }
    };

    const TEAMS = [
      { id: "T·ªï 1", color: "#00f3ff" },
      { id: "T·ªï 2", color: "#bc13fe" },
      { id: "T·ªï 3", color: "#ff0055" },
      { id: "T·ªï 4", color: "#00ff9d" }
    ];

    let realtimeTeams = {};
    let adminLogged = false;
    let adminLastAction = null;

    /* -------------------------
       galaxy object (main)
       ------------------------- */
    const galaxy = {
      team: null,

      init: async function() {
        // load theme
        const savedTheme = localStorage.getItem("7a4_theme") || "galaxy";
        document.body.setAttribute("data-theme", savedTheme);
        // toggle hoa mai visibility when tet theme active
        updateDecorVisibility();

        this.setupRealtimeListeners();
        await this.checkWeeklyResetFirestore();

        const saved = localStorage.getItem('7a4_member');
        if (saved) {
          this.team = saved;
          this.showMain();
        } else {
          this.showSelector();
        }

        this.renderRank();

        window.addEventListener('storage', (e) => {
          if (!e.key) return;
          if (e.key.startsWith('score_') || e.key === '7a4_last_reset' || e.key === '7a4_prev_winners') {
            this.renderRank();
          }
        });

        // attach fireworks trigger on buttons (for T·∫øt theme)
        attachButtonFireworkTriggers();
      },

      openStyleSettings() {
        document.getElementById('style-overlay').classList.remove('hidden');
      },
      closeStyleSettings() {
        document.getElementById('style-overlay').classList.add('hidden');
      },
      setTheme(theme) {
        document.body.setAttribute('data-theme', theme);
        localStorage.setItem('7a4_theme', theme);
        updateDecorVisibility();
        this.toast("ƒê√£ ƒë·ªïi phong c√°ch: " + (theme === "tet" ? "T·∫øt" : "Galaxy"));
      },

      selectTeam(name) {
        this.team = name;
        localStorage.setItem('7a4_member', name);
        this.showMain();
      },

      showSelector() {
        document.getElementById('selector-screen').style.display = 'flex';
        document.getElementById('main-app').classList.add('hidden');
        document.getElementById('main-app').style.display = 'none';
      },

      showMain() {
        document.getElementById('selector-screen').style.display = 'none';
        document.getElementById('main-app').classList.remove('hidden');
        document.getElementById('main-app').style.display = 'block';
        document.getElementById('team-tag').innerText = this.team;
        const color = TEAMS.find(t => t.id === this.team).color;
        document.getElementById('team-tag').style.background = color;
        this.renderRank();
      },

      logout() {
        localStorage.removeItem('7a4_member');
        this.team = null;
        this.showSelector();
      },

      teamToDocId(teamLabel) {
        if (!teamLabel) return null;
        const num = teamLabel.replace(/\D/g,'');
        return 'to' + num;
      },

      toast(msg){
        const t = document.getElementById("toast");
        t.innerText = msg;
        t.classList.add("show");
        clearTimeout(this._toastTimer);
        this._toastTimer = setTimeout(()=> t.classList.remove("show"), 1600);
      },

      applyTransition(){ /* placeholder if needed */ },

      closeGame(){
        document.getElementById('game-overlay').classList.add('hidden');
      },

      renderRank(){
        const list = document.getElementById("ranking-list");
        if (!list) return;
        const items = Object.keys(DOC_TO_TEAM).map(docId=>{
          const t = DOC_TO_TEAM[docId];
          const score = realtimeTeams[docId]?.score ?? 0;
          return { docId, name: t.id, color: t.color, score };
        }).sort((a,b)=> b.score - a.score);

        list.innerHTML = items.map((it, idx)=>`
          <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-radius:12px; background:rgba(255,255,255,0.02); margin-top:8px; font-weight:900;">
            <div style="display:flex; align-items:center; gap:10px;">
              <div style="width:30px; height:30px; border-radius:8px; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.35); border:1px solid rgba(255,255,255,0.08);">${idx+1}</div>
              <span style="color:${it.color};">${it.name}</span>
            </div>
            <span style="font-size:1.02rem;">${it.score}</span>
          </div>
        `).join("");

        const mini = document.getElementById("mini-rank-list");
        if (mini){
          mini.innerHTML = items.map(it=>`
            <div class="mini-rank-item"><span style="color:${it.color}">${it.name}</span><span>${it.score}</span></div>
          `).join("");
        }

        this.renderPrevWinner();
      },

      renderPrevWinner(){
        // keep your previous logic (placeholder)
      },

      async addPoints(p) {
        if (!this.team) return;
        const docId = this.teamToDocId(this.team);
        if (!docId) return;
        const ref = doc(db, "teams", docId);
        try {
          const s = await getDoc(ref);
          if (!s.exists()) {
            await setDoc(ref, { name: DOC_TO_TEAM[docId].id, score: 0, updatedAt: Date.now() });
          }
          await updateDoc(ref, { score: increment(p), updatedAt: Date.now() });
          this.toast(`+${p} ƒêI·ªÇM!`);
        } catch(e) {
          console.error(e); this.toast("L·ªói ƒë·ªìng b·ªô ƒëi·ªÉm");
        }
      },

      async ensureTeamsDocs(){
        for (const id of Object.keys(DOC_TO_TEAM)){
          const ref = doc(db, "teams", id);
          const s = await getDoc(ref);
          if (!s.exists()) await setDoc(ref, { name: DOC_TO_TEAM[id].id, score:0, updatedAt: Date.now() });
        }
      },

      async adminAdjustPoints(docId, delta){
        if (!adminLogged) { this.toast("C·∫ßn ƒëƒÉng nh·∫≠p Admin"); return; }
        const ref = doc(db, "teams", docId);
        try {
          const s = await getDoc(ref);
          if (!s.exists()) await setDoc(ref, { name: DOC_TO_TEAM[docId].id, score:0, updatedAt: Date.now() });
          await updateDoc(ref, { score: increment(delta), updatedAt: Date.now() });
          adminLastAction = { type: "adjust", docId, delta };
          this.toast((delta>0?"+":"") + delta + " ƒëi·ªÉm");
        } catch(e){ console.error(e); this.toast("L·ªói Admin update"); }
      },

      // implement toggleAdminPrompt and logoutAdmin (previously missing)
      toggleAdminPrompt(){
        const ok = prompt("Nh·∫≠p m·∫≠t kh·∫©u Admin:");
        if (ok === null) return;
        if (ok === ADMIN_PASSWORD) {
          adminLogged = true;
          const panel = document.getElementById('admin-panel');
          if (panel){
            panel.classList.remove('hidden');
            panel.style.display = 'block';
            panel.setAttribute('aria-hidden','false');
          }
          this.toast("ƒêƒÉng nh·∫≠p Admin th√†nh c√¥ng");
        } else {
          alert("M·∫≠t kh·∫©u sai");
        }
      },

      logoutAdmin(){
        adminLogged = false;
        const panel = document.getElementById('admin-panel');
        if (panel){
          panel.classList.add('hidden');
          panel.style.display = 'none';
          panel.setAttribute('aria-hidden','true');
        }
        this.toast("ƒê√£ ƒëƒÉng xu·∫•t Admin");
      },

      async checkWeeklyResetFirestore(){
        try {
          // keep your reset logic
          const now = new Date();
          const reset = new Date(now);
          const day = reset.getDay();
          reset.setDate(now.getDate() - day);
          reset.setHours(12,0,0,0);
          if (now.getDay() === 0 && now.getHours() < 12) reset.setDate(reset.getDate() - 7);
          if (reset.getTime() > now.getTime()) reset.setDate(reset.getDate() - 7);
          const resetTime = reset.getTime();

          const metaRef = doc(db, "meta", "weekly");
          const metaSnap = await getDoc(metaRef);
          const lastReset = metaSnap.exists() ? (metaSnap.data().lastReset || 0) : 0;

          if (!lastReset || lastReset < resetTime) {
            const colSnap = await getDocs(collection(db, "teams"));
            const prevScores = {};
            colSnap.forEach(d => prevScores[d.id] = d.data().score || 0);
            const arr = Object.entries(prevScores);
            const maxScore = arr.length ? Math.max(...arr.map(a=>a[1])) : 0;
            const winners = arr.filter(a=>a[1]===maxScore).map(a=> DOC_TO_TEAM[a[0]]?.id ?? a[0]);
            const batch = writeBatch(db);
            colSnap.forEach(d => batch.update(doc(db, "teams", d.id), { score:0, updatedAt: Date.now() }));
            batch.set(metaRef, { lastReset: resetTime, prevScores, winners, maxScore, updatedAt: Date.now() }, { merge: true });
            await batch.commit();
          }
        } catch(e) { console.error(e); }
      },

      setupRealtimeListeners(){
        try {
          onSnapshot(collection(db, "teams"), (snapshot) => {
            const tmp = {};
            snapshot.forEach(d => tmp[d.id] = d.data());
            realtimeTeams = tmp;
            this.renderRank();
          });
          onSnapshot(doc(db, "meta", "weekly"), () => {
            this.renderPrevWinner();
          });
        } catch(e) { console.error(e); }
      }
    };

    /* -------------------------
       ADMIN helpers (reused)
       ------------------------- */
    function adminAdjust(docId, delta) { galaxy.adminAdjustPoints(docId, delta); }

    async function adminApplyInput(docId){
      if (!adminLogged) { galaxy.toast("C·∫ßn ƒëƒÉng nh·∫≠p Admin"); return; }
      const input = document.getElementById("admin-point-input");
      const val = parseInt((input?.value || "").trim(), 10);
      if (!input || isNaN(val) || val === 0) { galaxy.toast("Nh·∫≠p s·ªë ƒëi·ªÉm h·ª£p l·ªá (kh√°c 0)"); return; }
      await galaxy.adminAdjustPoints(docId, val);
      input.value = "";
    }

    async function adminResetScores(){
      if (!adminLogged) { galaxy.toast("C·∫ßn ƒëƒÉng nh·∫≠p Admin"); return; }
      try {
        await galaxy.ensureTeamsDocs();
        const colSnap = await getDocs(collection(db, "teams"));
        const before = {};
        colSnap.forEach(d => before[d.id] = d.data().score || 0);
        const batch = writeBatch(db);
        colSnap.forEach(d => batch.update(doc(db, "teams", d.id), { score:0, updatedAt: Date.now() }));
        await batch.commit();
        adminLastAction = { type:"reset", before };
        galaxy.toast("ƒê√£ RESET ƒëi·ªÉm t·∫•t c·∫£ t·ªï");
      } catch(e){ console.error(e); galaxy.toast("L·ªói reset ƒëi·ªÉm"); }
    }

    async function adminUndo(){
      if (!adminLogged) { galaxy.toast("C·∫ßn ƒëƒÉng nh·∫≠p Admin"); return; }
      if (!adminLastAction){ galaxy.toast("Kh√¥ng c√≥ h√†nh ƒë·ªông ƒë·ªÉ ho√†n t√°c"); return; }
      try {
        if (adminLastAction.type === "adjust") {
          const { docId, delta } = adminLastAction;
          await galaxy.adminAdjustPoints(docId, -delta);
          adminLastAction = null;
          galaxy.toast("ƒê√£ ho√†n t√°c ƒëi·ªÅu ch·ªânh ƒëi·ªÉm");
          return;
        }
        if (adminLastAction.type === "reset"){
          const before = adminLastAction.before || {};
          const batch = writeBatch(db);
          for (const docId of Object.keys(DOC_TO_TEAM)) {
            const ref = doc(db, "teams", docId);
            const score = before[docId] ?? 0;
            batch.update(ref, { score, updatedAt: Date.now() });
          }
          await batch.commit();
          adminLastAction = null;
          galaxy.toast("ƒê√£ ho√†n t√°c RESET");
          return;
        }
      } catch(e){ console.error(e); galaxy.toast("L·ªói ho√†n t√°c"); }
    }

    /* -------------------------
       GAMES: Math & English
       (kept mostly unchanged, only changed feedback -> toast)
       ------------------------- */
    const mathGame = {
      ans:0, isProcessing:false,
      start(){ document.getElementById('game-overlay').classList.remove('hidden'); document.getElementById('game-label').innerText="MATH MISSION"; galaxy.renderRank(); this.generate(); },
      generate(){
        this.isProcessing=false;
        document.getElementById('q-tag').innerText = "MATH ‚Ä¢ HK2";
        const type = Math.floor(Math.random()*4);
        let q="";
        document.getElementById('q-feedback').innerText = "";
        if (type===0){ const a=Math.floor(Math.random()*100), b=Math.floor(Math.random()*50); this.ans=a+b; q=`${a} + ${b} = ?`; }
        else if (type===1){ const a=Math.floor(Math.random()*12)+2, b=Math.floor(Math.random()*11)+2; this.ans=a*b; q=`${a} √ó ${b} = ?`; }
        else if (type===2){ const x=Math.floor(Math.random()*30), a=Math.floor(Math.random()*20); this.ans=x; q=`T√¨m x: x + ${a} = ${x + a}`; }
        else { const b=Math.floor(Math.random()*5)+2, p=Math.floor(Math.random()*2)+2; this.ans=Math.pow(b,p); q=`${b}<sup>${p}</sup> = ?`; }
        document.getElementById('q-text').innerHTML = q;
        document.getElementById('q-action').innerHTML = `
          <input type="number" id="m-input" class="math-input" autofocus>
          <div style="display:flex; gap:10px; margin-top:8px; justify-content:center;">
            <button id="btn-m-confirm" class="btn-confirm" onclick="mathGame.check()">X√ÅC NH·∫¨N</button>
            <button class="btn-confirm small" style="background:rgba(255,255,255,0.1); border:1px solid #777;" onclick="mathGame.skip()">B·ªé QUA</button>
          </div>
        `;
        const input = document.getElementById('m-input'); if (input) input.focus();
      },
      check(){ if(this.isProcessing) return; this.isProcessing=true; const btn=document.getElementById('btn-m-confirm'); if(btn) btn.disabled=true;
        const val=parseInt(document.getElementById('m-input').value||'',10);
        if (val===this.ans){ document.getElementById('q-feedback').innerText=""; galaxy.toast("CH√çNH X√ÅC! +5 XP"); galaxy.addPoints(5); setTimeout(()=>this.generate(),700); }
        else{ document.getElementById('q-feedback').innerText=""; galaxy.toast("SAI R·ªíI!"); setTimeout(()=>this.generate(),1100); }
      },
      skip(){ if(this.isProcessing) return; this.isProcessing=true; document.getElementById('q-feedback').innerText=""; galaxy.toast("ƒê√É B·ªé QUA"); setTimeout(()=>{ this.isProcessing=false; this.generate(); },650); }
    };

    const ENGLISH_BANK = [
      { q: "She is a very ________ designer. She always has new ideas.", a: "creative", o: ["creative","creatively","creation"], t:"Adj_Adv" },
      { q: "He decorated the room ________ for the party.", a: "creatively", o: ["creative","creatively","create"], t:"Adj_Adv" },
      { q: "You should be ________ when speaking to elderly people.", a:"polite", o:["polite","politely","politeness"], t:"Adj_Adv" },
      { q: "The boy replied ________ to the teacher and got into trouble.", a:"rudely", o:["rude","rudely","rudeness"], t:"Adj_Adv" },
      { q: "It was ________ of him to ignore my question.", a:"rude", o:["rude","rudely","rudest"], t:"Adj_Adv" },
      { q: "If you don't know the meaning of a word, you can guess it from the ________.", a:"context", o:["context","medal","ton"], t:"Reading" }
      // (keep your full bank in the file; trimmed here for brevity)
    ];

    const englishGame = {
      curr:null, lastIndex:-1, isProcessing:false,
      start(){ document.getElementById('game-overlay').classList.remove('hidden'); document.getElementById('game-label').innerText="ENGLISH COMMAND"; galaxy.renderRank(); this.generate(); },
      generate(){
        this.isProcessing=false;
        if(ENGLISH_BANK.length===0) return;
        let idx=Math.floor(Math.random()*ENGLISH_BANK.length), attempts=0;
        while(idx===this.lastIndex && attempts<10){ idx=Math.floor(Math.random()*ENGLISH_BANK.length); attempts++; }
        this.lastIndex=idx;
        this.curr = ENGLISH_BANK[idx];
        document.getElementById('q-feedback').innerText="";
        document.getElementById('q-text').innerText=this.curr.q;
        document.getElementById('q-tag').innerText=this.curr.t + " ‚Ä¢ HK2";
        const shuffled = [...this.curr.o].sort(()=>Math.random()-0.5);
        document.getElementById('q-action').innerHTML = `
          <div class="option-list">
            ${shuffled.map(o=>`<button class="option-item" onclick="englishGame.check(this,'${o.replace(/'/g,"\\'")}')">${o}</button>`).join('')}
          </div>
          <div style="width:100%; display:flex; justify-content:center; margin-top:10px;">
            <button class="btn-confirm small" style="background:rgba(255,255,255,0.1); border:1px solid #777;" onclick="englishGame.skip()">B·ªé QUA</button>
          </div>
        `;
      },
      check(btn, choice){
        if(this.isProcessing) return;
        this.isProcessing=true;
        document.querySelectorAll('.option-item').forEach(b=>b.disabled=true);
        if(choice === this.curr.a){ document.getElementById('q-feedback').innerText=""; galaxy.toast("ƒê√öNG R·ªíI! +10 XP"); galaxy.addPoints(10); setTimeout(()=>this.generate(),750); }
        else{ document.getElementById('q-feedback').innerText=""; galaxy.toast(`SAI! ƒê√ÅP √ÅN: ${this.curr.a}`); setTimeout(()=>this.generate(),1500); }
      },
      skip(){ if(this.isProcessing) return; this.isProcessing=true; document.getElementById('q-feedback').innerText=""; galaxy.toast("ƒê√É B·ªé QUA"); setTimeout(()=>{ this.isProcessing=false; this.generate(); },650); }
    };

    // expose globally used objects (some onclick handlers use them)
    window.galaxy = galaxy;
    window.mathGame = mathGame;
    window.englishGame = englishGame;
    window.adminAdjust = adminAdjust;
    window.adminApplyInput = adminApplyInput;
    window.adminResetScores = adminResetScores;
    window.adminUndo = adminUndo;
    window.galaxy.logoutAdmin = galaxy.logoutAdmin.bind(galaxy);

    /* -------------------------
       DECOR & FIREWORKS LOGIC
       ------------------------- */
    const fireworksCanvas = document.getElementById('fireworks-canvas');
    const fwCtx = fireworksCanvas.getContext ? fireworksCanvas.getContext('2d') : null;
    let fwWidth = 0, fwHeight = 0, fwParticles = [];

    function resizeFW() {
      fireworksCanvas.width = fwWidth = window.innerWidth;
      fireworksCanvas.height = fwHeight = window.innerHeight;
    }
    window.addEventListener('resize', resizeFW);
    resizeFW();

    function Particle(x,y,color,velX,velY,size,life){
      this.x = x; this.y = y; this.vx = velX; this.vy = velY; this.color = color; this.size = size; this.life = life; this.alpha = 1;
    }
    Particle.prototype.update = function(dt){
      this.x += this.vx * dt;
      this.y += this.vy * dt;
      this.vy += 0.06 * dt; // gravity
      this.life -= 1 * dt;
      this.alpha = Math.max(0, this.life/60);
    };
    Particle.prototype.draw = function(ctx){
      ctx.globalAlpha = this.alpha;
      ctx.beginPath();
      ctx.fillStyle = this.color;
      ctx.arc(this.x, this.y, Math.max(0.6, this.size), 0, Math.PI*2);
      ctx.fill();
      ctx.globalAlpha = 1;
    };

    let lastTime = performance.now();
    function fwLoop(now){
      const dt = Math.min(34, now - lastTime) / 16; // normalized
      lastTime = now;
      if (!fwCtx) { requestAnimationFrame(fwLoop); return; }
      fwCtx.clearRect(0,0,fwWidth,fwHeight);

      for (let i = fwParticles.length-1; i>=0; i--){
        const p = fwParticles[i];
        p.update(dt);
        p.draw(fwCtx);
        if (p.life <= 0) fwParticles.splice(i,1);
      }
      if (fwParticles.length>0) fireworksCanvas.style.display = 'block';
      else fireworksCanvas.style.display = 'none';
      requestAnimationFrame(fwLoop);
    }
    requestAnimationFrame(fwLoop);

    // create a small burst (called on button click) only when T·∫øt theme
    function triggerFireworksAt(x,y){
      const theme = document.body.getAttribute('data-theme') || 'galaxy';
      if (theme !== 'tet') return;
      const colors = ['#ffcc33','#ff4d4d','#ff2d8a','#fff2cc','#ffd27f'];
      for (let i=0;i<28;i++){
        const angle = Math.random()*Math.PI*2;
        const speed = 1 + Math.random()*4;
        const vx = Math.cos(angle) * speed * (Math.random()*1.2);
        const vy = Math.sin(angle) * speed * (Math.random()*1.2);
        const size = 1 + Math.random()*3;
        const color = colors[Math.floor(Math.random()*colors.length)];
        fwParticles.push(new Particle(x, y, color, vx, vy, size, 40 + Math.random()*40));
      }
    }

    // attach listeners to all buttons so when clicked in Tet theme they show fireworks
    function attachButtonFireworkTriggers(){
      document.querySelectorAll('button, .team-card, .mission-card').forEach(el=>{
        el.addEventListener('click', (ev)=>{
          const theme = document.body.getAttribute('data-theme') || 'galaxy';
          if (theme !== 'tet') return;
          // coordinates relative to viewport
          const rect = el.getBoundingClientRect();
          const cx = rect.left + rect.width/2 + (Math.random()*40-20);
          const cy = rect.top + rect.height/2 + (Math.random()*40-20);
          triggerFireworksAt(cx, cy);
        });
      });
    }

    // show/hide hoa mai and adjust some t·∫øt accents
    function updateDecorVisibility(){
      const theme = document.body.getAttribute('data-theme') || 'galaxy';
      const h1 = document.getElementById('hoa-mai-1');
      const h2 = document.getElementById('hoa-mai-2');
      if (theme === 'tet'){
        h1.classList.remove('hidden'); h2.classList.remove('hidden');
        // stronger golden borders on admin panel
        const ap = document.getElementById('admin-panel');
        if (ap) ap.style.border = '1px solid rgba(255,210,80,0.25)';
      } else {
        h1.classList.add('hidden'); h2.classList.add('hidden');
        const ap = document.getElementById('admin-panel');
        if (ap) ap.style.border = '1px solid var(--glass-border)';
      }
    }

    // also re-attach button triggers after theme change or DOM changes
    const mo = new MutationObserver(()=> attachButtonFireworkTriggers());
    mo.observe(document.body, { childList:true, subtree:true });

    /* -------------------------
       Setup & init
       ------------------------- */
    window.onload = () => {
      galaxy.init();
      // ensure admin panel hidden until login
      document.getElementById('admin-panel').classList.add('hidden');
      document.getElementById('game-overlay').classList.add('hidden');

      // call attach once here
      attachButtonFireworkTriggers();
    };

    // expose fireworks trigger (if needed)
    window.triggerFireworksAt = triggerFireworksAt;

  </script>
</body>
</html>
