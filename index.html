<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>7A4 GALAXY COMMAND</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    
    <style>
        /* =========================================
           CORE VARIABLES (GALAXY - DEFAULT)
           ========================================= */
        :root {
            --primary: #00f3ff;
            --secondary: #bc13fe;
            --accent: #ff0055;
            --success: #00ff9d;
            --dark-bg: #030712;
            --card-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #fff;
            --font-main: 'Montserrat', sans-serif;
            --bg-image: radial-gradient(circle at 20% 30%, rgba(0, 243, 255, 0.05) 0%, transparent 50%),
                        radial-gradient(circle at 80% 70%, rgba(188, 19, 254, 0.05) 0%, transparent 50%);
            --toast-bg: rgba(255, 255, 255, 0.95);
            --toast-text: #000;
        }

        /* =========================================
           THEME: T·∫æT (LUNAR NEW YEAR)
           ========================================= */
        body.theme-tet {
            --primary: #FFD700; /* V√†ng kim */
            --secondary: #ff3333; /* ƒê·ªè t∆∞∆°i */
            --accent: #ff0000;
            --success: #32CD32;
            --dark-bg: #2a0202; /* ƒê·ªè ƒëen ƒë·∫≠m */
            --card-bg: rgba(255, 215, 0, 0.05); /* V√†ng nh·∫°t */
            --glass-border: rgba(255, 215, 0, 0.3); /* Vi·ªÅn v√†ng */
            --text-main: #fff;
            --bg-image: 
                radial-gradient(circle at 10% 20%, rgba(255, 215, 0, 0.2) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(255, 0, 0, 0.2) 0%, transparent 40%),
                url('data:image/svg+xml;utf8,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%23ffd700" fill-opacity="0.1"%3E%3Cpath d="M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');
        }
        
        body.theme-tet .hero-title {
            font-family: 'Dancing Script', cursive; /* Font th∆∞ ph√°p nh·∫π */
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        body.theme-tet .btn-confirm {
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }
        body.theme-tet .q-tag {
            background: rgba(255, 0, 0, 0.3);
            border-color: var(--primary);
            color: var(--primary);
        }

        /* =========================================
           BASE STYLES
           ========================================= */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-main);
            background: var(--dark-bg);
            color: var(--text-main);
            margin: 0;
            min-height: 100vh;
            overflow-x: hidden;
            background-image: var(--bg-image);
            transition: background 0.5s ease, color 0.5s ease;
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes floating { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

        .animate-in { animation: fadeIn 0.5s ease forwards; }
        .slide-in { animation: slideIn 0.3s ease-out forwards; }

        /* UI Components */
        #toast {
            position: fixed; top: 30px; left: 50%; transform: translateX(-50%);
            background: var(--toast-bg); color: var(--toast-text);
            padding: 12px 25px; border-radius: 50px;
            font-weight: 800; z-index: 10000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            opacity: 0; pointer-events: none; transition: 0.3s;
            text-align: center; white-space: nowrap;
        }
        #toast.success { background: var(--success); color: #000; }
        #toast.error { background: var(--accent); color: #fff; }
        #toast.info { background: #555; color: #fff; }

        /* Selector Screen */
        #selector-screen {
            position: fixed; inset: 0; background: var(--dark-bg);
            z-index: 9999; display: flex; flex-direction: column;
            justify-content: center; align-items: center; padding: 20px;
            text-align: center;
        }

        .hero-title {
            font-size: clamp(2rem, 8vw, 3.5rem); font-weight: 900;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text; color: transparent;
            margin-bottom: 10px; letter-spacing: -1px;
        }

        .team-grid {
            display: grid; grid-template-columns: repeat(2, 1fr);
            gap: 15px; width: 100%; max-width: 500px; margin-top: 40px;
        }

        .team-card {
            background: var(--card-bg); border: 1px solid var(--glass-border);
            padding: 30px 10px; border-radius: 20px; font-weight: 800;
            cursor: pointer; transition: 0.3s; text-transform: uppercase;
        }
        .team-card:hover { background: rgba(255,255,255,0.1); transform: scale(1.05); border-color: var(--primary); }

        /* App Layout */
        header {
            padding: 20px; display: flex; justify-content: space-between;
            align-items: center; 
            background: var(--dark-bg);
            position: sticky; top: 0; z-index: 100;
            border-bottom: 1px solid var(--glass-border);
        }

        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }

        .rank-card {
            background: var(--card-bg); border-radius: 24px; padding: 25px;
            margin-bottom: 20px; border: 1px solid var(--glass-border);
            position: relative;
        }

        .rank-item { margin-bottom: 15px; }
        .rank-label { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: 700; font-size: 0.9rem; }
        .bar-outer { background: rgba(255,255,255,0.05); height: 14px; border-radius: 10px; overflow: hidden; }
        .bar-inner { height: 100%; border-radius: 10px; transition: width 1s cubic-bezier(0.34, 1.56, 0.64, 1); }

        .reset-notice {
            text-align: center; font-size: 0.75rem; color: #888; margin-top: 15px; font-weight: 600;
            border-top: 1px dashed rgba(255,255,255,0.1); padding-top: 10px;
        }

        .tiktok-group { display: flex; gap: 12px; margin-bottom: 30px; }
        .tiktok-link {
            flex: 1; display: flex; align-items: center; justify-content: center;
            gap: 10px; background: #000; padding: 15px; border-radius: 16px;
            text-decoration: none; color: #fff; font-weight: 800; font-size: 0.85rem;
            border: 1px solid var(--glass-border); transition: 0.3s;
        }
        .tiktok-link:hover { transform: translateY(-3px); border-color: var(--primary); }

        .mission-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .mission-card {
            background: var(--card-bg); padding: 30px; border-radius: 24px;
            border: 1px solid var(--glass-border); cursor: pointer;
            transition: 0.3s; position: relative; overflow: hidden;
            animation: floating 4s ease-in-out infinite;
        }
        .mission-card:hover { background: rgba(255,255,255,0.08); border-color: var(--primary); }
        .mission-card.locked { opacity: 0.5; cursor: not-allowed; animation: none; }

        .mission-icon { font-size: 3rem; margin-bottom: 15px; display: block; }
        .mission-name { font-size: 1.4rem; font-weight: 900; margin-bottom: 8px; color: var(--primary); }
        .mission-desc { font-size: 0.9rem; color: #aaa; line-height: 1.4; }

        .badge-soon {
            position: absolute; top: 12px; right: -30px; background: #febd23;
            color: #000; padding: 4px 35px; font-size: 0.65rem;
            font-weight: 900; transform: rotate(45deg);
        }

        /* Update Card */
        .update-card {
            background: rgba(255,255,255,0.03); border: 1px dashed rgba(255,255,255,0.06);
            padding: 12px 14px; border-radius: 12px; color: #ddd; font-weight: 700; margin-bottom: 18px;
        }

        /* =========================================
           SETTINGS MODAL
           ========================================= */
        #settings-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000;
            display: none; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .settings-content {
            background: var(--dark-bg); border: 1px solid var(--glass-border);
            padding: 30px; border-radius: 24px; width: 90%; max-width: 400px;
            text-align: center;
        }
        .theme-btn {
            width: 100%; padding: 15px; margin-bottom: 10px;
            border: 1px solid var(--glass-border); border-radius: 12px;
            font-weight: 800; cursor: pointer; transition: 0.2s;
            background: rgba(255,255,255,0.05); color: #fff;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .theme-btn:hover { border-color: var(--primary); background: rgba(255,255,255,0.1); }
        .theme-btn.active { border-color: var(--primary); background: rgba(0, 243, 255, 0.1); color: var(--primary); }
        
        /* =========================================
           ADMIN PANEL
           ========================================= */
        #admin-panel {
            position: fixed; right: 20px; top: 80px; 
            background: rgba(3, 7, 18, 0.95); backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border); padding: 15px; 
            border-radius: 16px; z-index: 1100; display: none; 
            width: 300px; font-weight: 700; max-height: 75vh; overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
        }
        #admin-panel::-webkit-scrollbar { width: 6px; }
        #admin-panel::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); }
        #admin-panel::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 10px; }
        #admin-panel input {
            width: 100%; padding: 12px 12px; border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.4);
            color: #fff; font-weight: 800; outline: none; margin-bottom: 12px;
        }
        .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
        .admin-section-title {
            font-size: 0.8rem; color: #888; margin-bottom: 8px; 
            text-transform: uppercase; letter-spacing: 1px;
            border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 4px; margin-top: 10px;
        }

        /* =========================================
           GAME OVERLAY (Redesigned)
           ========================================= */
        #game-overlay {
            position: fixed; inset: 0; 
            background: var(--dark-bg); /* Use theme bg */
            z-index: 1000; display: none; 
            flex-direction: column; padding: 20px;
        }

        .game-header {
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 20px; padding: 15px 20px;
            background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border);
            border-radius: 20px;
        }

        .btn-exit {
            background: rgba(255, 50, 50, 0.1); border: 1px solid rgba(255, 50, 50, 0.3);
            color: #ff5a5a; padding: 8px 16px; border-radius: 10px;
            font-weight: 800; font-size: 0.9rem; cursor: pointer; transition: 0.3s;
            font-family: inherit; display: flex; align-items: center; gap: 5px;
        }
        .btn-exit:hover { background: #ff5a5a; color: #000; }

        .game-container-box {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: flex-start; /* Changed to start to allow scroll if needed */
            max-width: 600px; width: 100%; margin: 0 auto;
            position: relative; overflow-y: auto;
        }

        /* UPDATED: Mini Scoreboard */
        .mini-rank-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 4 columns for 4 teams */
            gap: 10px; width: 100%; margin-bottom: 20px;
        }
        .mini-rank-item {
            background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border);
            padding: 8px 5px; border-radius: 12px;
            font-size: 0.9rem; font-weight: 800;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: 0.3s;
        }
        .mini-rank-item span:first-child { font-size: 0.75rem; opacity: 0.8; margin-bottom: 2px; }

        .question-card {
            width: 100%;
            background: radial-gradient(circle at center, rgba(255,255,255,0.03) 0%, transparent 70%);
            padding: 20px; border-radius: 30px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 300px;
        }

        .q-tag { 
            background: rgba(0, 243, 255, 0.1); color: var(--primary); 
            padding: 6px 18px; border-radius: 20px; font-size: 0.8rem; 
            font-weight: 800; margin-bottom: 20px; text-transform: uppercase; 
            border: 1px solid rgba(0, 243, 255, 0.2); 
        }
        .q-text { 
            font-size: clamp(1.3rem, 4vw, 2rem); font-weight: 800; 
            text-align: center; margin-bottom: 30px; line-height: 1.4; 
            text-shadow: 0 0 20px rgba(0,0,0,0.5); 
        }

        .option-list { display: grid; gap: 14px; width: 100%; margin-bottom: 10px; }
        .option-item {
            background: var(--card-bg); border: 1px solid var(--glass-border);
            padding: 18px 20px; border-radius: 16px; color: #fff;
            text-align: left; font-weight: 700; font-size: 1rem; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: space-between;
        }
        .option-item:hover { background: rgba(255,255,255,0.1); border-color: var(--primary); transform: translateX(5px); }
        .option-item:active { transform: scale(0.98); }
        .option-item:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        .math-input {
            background: transparent; border: none; border-bottom: 4px solid var(--primary);
            color: #fff; font-size: 3.5rem; width: 100%; text-align: center;
            font-weight: 900; outline: none; margin-bottom: 30px;
            padding-bottom: 10px;
        }

        .btn-confirm {
            background: var(--primary); color: #000; width: 100%; padding: 16px 20px;
            border-radius: 14px; font-weight: 900; font-size: 1.0rem; margin-top: 10px; border: none; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 243, 255, 0.3);
            transition: 0.3s;
        }
        .btn-confirm:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 243, 255, 0.5); }
        
        /* Updated Skip/Small Button Font */
        .btn-confirm.small { 
            width: auto; padding: 12px 25px; 
            font-size: 0.95rem; /* Larger font */
            font-family: inherit; /* Ensure font matches theme */
            letter-spacing: 0.5px;
            border-radius: 12px; box-shadow: none; 
        }
        .btn-confirm:disabled { background: #555; cursor: not-allowed; box-shadow: none; transform: none; }

        footer {
            margin-top: 30px; padding: 30px; text-align: center;
            border-top: 1px solid var(--glass-border); color: #555; font-size: 0.8rem;
        }

        .hidden { display: none !important; }

        /* Media Queries */
        @media (max-width: 600px) {
            .mission-grid { grid-template-columns: 1fr; }
            .hero-title { font-size: 2.2rem; }
            .q-text { font-size: 1.2rem; }
            .option-item { padding: 14px 15px; font-size: 0.95rem; }
            .math-input { font-size: 2.4rem; }

            header{ padding: 14px; }
            #user-info{ gap: 8px !important; }
            #admin-btn{ padding: 8px 10px; border-radius: 10px; background: rgba(255,255,255,0.06); }
            header button{ padding: 8px; border-radius: 10px; }
            
            #admin-panel{
                left: 50%; right: auto; top: auto; bottom: 20px;
                transform: translateX(-50%); width: 95%; max-width: 420px;
                max-height: 60vh; border-radius: 20px; padding: 20px;
            }
            
            .mini-rank-grid { gap: 6px; }
            .mini-rank-item { padding: 6px 4px; border-radius: 8px; }
            .mini-rank-item span:last-child { font-size: 0.95rem; }
        }
    </style>
</head>
<body>

    <div id="toast">Th√¥ng b√°o</div>

    <div id="selector-screen">
        <div class="hero-title animate-in">7A4 GALAXY<br>COMMAND</div>
        <p class="animate-in" style="color: #aaa; letter-spacing: 2px; font-size: 0.75rem; font-weight: 600;">H·ªÜ TH·ªêNG √îN T·∫¨P HK2</p>
        
        <div class="team-grid animate-in" style="animation-delay: 0.2s;">
            <div class="team-card" onclick="galaxy.selectTeam('T·ªï 1')" style="color: var(--primary)">T·ªï 1</div>
            <div class="team-card" onclick="galaxy.selectTeam('T·ªï 2')" style="color: var(--secondary)">T·ªï 2</div>
            <div class="team-card" onclick="galaxy.selectTeam('T·ªï 3')" style="color: var(--accent)">T·ªï 3</div>
            <div class="team-card" onclick="galaxy.selectTeam('T·ªï 4')" style="color: var(--success)">T·ªï 4</div>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <header>
            <div style="font-weight: 900; letter-spacing: 1px; font-size: 1.1rem;">7A4 COMMAND</div>
            <div id="user-info" style="display: flex; align-items: center; gap: 15px;">
                <span id="team-tag" style="font-weight: 900; background: var(--primary); color: #000; padding: 4px 12px; border-radius: 8px; font-size: 0.8rem;"></span>
                
                <button onclick="galaxy.openSettings()" style="background:none; border:none; color:#ddd; cursor:pointer;" title="C√†i ƒë·∫∑t">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
                        <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319z"/>
                    </svg>
                </button>

                <button onclick="galaxy.logout()" style="background:none; border:none; color:#555; font-weight:bold; cursor:pointer; font-family:'Montserrat';">THO√ÅT</button>
                <button id="admin-btn" onclick="galaxy.toggleAdminPrompt()" style="background:none; border:none; color:#ddd; font-weight:700; cursor:pointer; font-family:'Montserrat';">Admin</button>
            </div>
        </header>

        <div class="container animate-in">
            <div class="rank-card">
                <h2 style="margin-top: 0; font-size: 1.1rem; text-align: center; color: var(--primary); text-transform: uppercase; letter-spacing: 2px;">ƒêi·ªÉm S·ªë Chi·∫øn ƒê·ªôi</h2>
                <div id="ranking-list"></div>
                <div id="prev-winner" style="margin-top:12px; font-weight:800; text-align:center; color:#ddd;"></div>
                <div class="reset-notice">
                    ‚è∞ H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông reset ƒëi·ªÉm v√†o m·ªói <strong>Ch·ªß nh·∫≠t 12:00</strong> (gi·ªù ƒë·ªãa ph∆∞∆°ng).
                </div>
            </div>

            <div class="update-card">
                B·∫£n c·∫≠p nh·∫≠t 1.3 ‚Äî <strong>T·ªëi ∆∞u Admin Panel</strong>, th√™m giao di·ªán T·∫æT, s·ª≠a l·ªói hi·ªÉn th·ªã Game.
            </div>

            <div class="tiktok-group">
                <a href="https://www.tiktok.com/@7a4.tvl.2025.2026" target="_blank" class="tiktok-link">TikTok A4 1</a>
                <a href="https://www.tiktok.com/@a4.tvl.2025.2026" target="_blank" class="tiktok-link">TikTok A4 2</a>
            </div>

            <div class="mission-grid">
                <div class="mission-card" onclick="englishGame.start()">
                    <span class="mission-icon">üá¨üáß</span>
                    <div class="mission-name">Ti·∫øng Anh HK2</div>
                    <div class="mission-desc">100+ c√¢u h·ªèi Vocabulary, Adverbs, How structure, Ability...</div>
                </div>

                <div class="mission-card" onclick="mathGame.start()">
                    <span class="mission-icon">üìê</span>
                    <div class="mission-name">To√°n H·ªçc</div>
                    <div class="mission-desc">C·ªông tr·ª´, nh√¢n chia, t√¨m x, s·ªë m≈©.</div>
                </div>

                <div class="mission-card locked">
                    <span class="badge-soon">S·∫ÆP C√ì</span>
                    <span class="mission-icon">üß™</span>
                    <div class="mission-name">KHTN</div>
                    <div class="mission-desc">H·ªá th·ªëng c√¢u h·ªèi √¥n t·∫≠p Khoa h·ªçc t·ª± nhi√™n.</div>
                </div>
            </div>

            <footer>
                *n·∫øu web c√≥ l·ªói g√¨ hay c√°c c√¢u h·ªèi sai xin li√™n h·ªá admin t·∫°i 2 trang tik tok c·ªßa l·ªõp.
            </footer>
        </div>
    </div>

    <div id="settings-modal">
        <div class="settings-content animate-in">
            <h3 style="color: var(--primary); text-transform: uppercase; margin-top: 0;">Giao di·ªán</h3>
            <button class="theme-btn" onclick="galaxy.setTheme('galaxy')">üåå Galaxy (M·∫∑c ƒë·ªãnh)</button>
            <button class="theme-btn" onclick="galaxy.setTheme('tet')">üå∏ T·∫øt ·∫§t T·ªµ (M·ªõi)</button>
            <button class="btn-confirm small" style="margin-top: 20px; width: 100%;" onclick="galaxy.closeSettings()">ƒê√≥ng</button>
        </div>
    </div>

    <div id="admin-panel">
        <div style="font-size:1.1rem; margin-bottom:15px; text-align:center; color:var(--primary); text-transform:uppercase;">Admin Tools</div>

        <div class="admin-section-title">Nh·∫≠p ƒëi·ªÉm (+/-)</div>
        <input id="admin-point-input" type="number" placeholder="V√≠ d·ª•: 10 ho·∫∑c -5" />

        <div class="admin-section-title">√Åp d·ª•ng cho</div>
        <div class="admin-grid">
            <button onclick="adminApplyInput('to1')" class="btn-confirm small" style="background: rgba(0, 243, 255, 0.2); border:1px solid #00f3ff; color:#00f3ff;">T·ªï 1</button>
            <button onclick="adminApplyInput('to2')" class="btn-confirm small" style="background: rgba(188, 19, 254, 0.2); border:1px solid #bc13fe; color:#bc13fe;">T·ªï 2</button>
            <button onclick="adminApplyInput('to3')" class="btn-confirm small" style="background: rgba(255, 0, 85, 0.2); border:1px solid #ff0055; color:#ff0055;">T·ªï 3</button>
            <button onclick="adminApplyInput('to4')" class="btn-confirm small" style="background: rgba(0, 255, 157, 0.2); border:1px solid #00ff9d; color:#00ff9d;">T·ªï 4</button>
        </div>

        <div class="admin-section-title">N√∫t nhanh (+/- 1)</div>
        <div style="display:flex; flex-direction:column; gap:4px; margin-bottom: 15px;">
            <div style="display:flex; gap:5px; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.05); padding:5px 8px; border-radius:8px;">
                <span style="font-size:0.8rem; color:#00f3ff">T·ªï 1</span>
                <div style="display:flex; gap:4px;">
                    <button onclick="adminAdjust('to1',1)" class="btn-confirm small" style="padding:4px 10px; font-size:0.8rem;">+1</button>
                    <button onclick="adminAdjust('to1',-1)" class="btn-confirm small" style="padding:4px 10px; font-size:0.8rem; background:#444;">-1</button>
                </div>
            </div>
            <div style="display:flex; gap:5px; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.05); padding:5px 8px; border-radius:8px;">
                <span style="font-size:0.8rem; color:#bc13fe">T·ªï 2</span>
                <div style="display:flex; gap:4px;">
                    <button onclick="adminAdjust('to2',1)" class="btn-confirm small" style="padding:4px 10px; font-size:0.8rem;">+1</button>
                    <button onclick="adminAdjust('to2',-1)" class="btn-confirm small" style="padding:4px 10px; font-size:0.8rem; background:#444;">-1</button>
                </div>
            </div>
            <div style="display:flex; gap:5px; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.05); padding:5px 8px; border-radius:8px;">
                <span style="font-size:0.8rem; color:#ff0055">T·ªï 3</span>
                <div style="display:flex; gap:4px;">
                    <button onclick="adminAdjust('to3',1)" class="btn-confirm small" style="padding:4px 10px; font-size:0.8rem;">+1</button>
                    <button onclick="adminAdjust('to3',-1)" class="btn-confirm small" style="padding:4px 10px; font-size:0.8rem; background:#444;">-1</button>
                </div>
            </div>
            <div style="display:flex; gap:5px; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.05); padding:5px 8px; border-radius:8px;">
                <span style="font-size:0.8rem; color:#00ff9d">T·ªï 4</span>
                <div style="display:flex; gap:4px;">
                    <button onclick="adminAdjust('to4',1)" class="btn-confirm small" style="padding:4px 10px; font-size:0.8rem;">+1</button>
                    <button onclick="adminAdjust('to4',-1)" class="btn-confirm small" style="padding:4px 10px; font-size:0.8rem; background:#444;">-1</button>
                </div>
            </div>
        </div>

        <div class="admin-section-title">H·ªá th·ªëng</div>
        <div style="display:grid; gap:8px;">
            <button onclick="adminUndo()" class="btn-confirm small" style="background:#888; width:100%;">‚Ü© HO√ÄN T√ÅC</button>
            <button onclick="adminResetScores()" class="btn-confirm small" style="background:#febd23; color:#000; width:100%;">‚ö† RESET ƒêI·ªÇM (ALL)</button>
            <button onclick="galaxy.logoutAdmin()" style="background:#ff5a5a; color:#fff; font-weight:900; border-radius:10px; padding:10px; border:none; width:100%; cursor:pointer;">ƒêƒÉng xu·∫•t</button>
        </div>
    </div>

    <div id="game-overlay">
        <div class="game-header">
            <div id="game-label" style="font-weight: 900; color: var(--primary); letter-spacing: 2px; font-size: 1.2rem;">MISSION</div>
            <button class="btn-exit" onclick="galaxy.closeGame()">
                <span>THO√ÅT</span> ‚úï
            </button>
        </div>
        
        <div class="game-container-box">
            <div id="mini-rank-list" class="mini-rank-grid"></div>

            <div class="question-card">
                <div id="q-tag" class="q-tag">Ki·∫øn th·ª©c HK2</div>
                <div id="game-content-area" style="width: 100%; display:flex; flex-direction:column; align-items:center;">
                    <div id="q-text" class="q-text">ƒêang t·∫£i c√¢u h·ªèi...</div>
                    <div id="q-action" style="width: 100%;"></div>
                </div>
                </div>
        </div>
    </div>

<script type="module">
  /***** Firebase setup *****/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, getDocs,
    writeBatch, increment
  } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBtdoU4bzBVsXXvYswbUf0smAuYIq9rxlM",
    authDomain: "a4-galaxy-command.firebaseapp.com",
    projectId: "a4-galaxy-command",
    storageBucket: "a4-galaxy-command.firebasestorage.app",
    messagingSenderId: "147400399283",
    appId: "1:147400399283:web:6d470d3e02a94e01f053c6",
    measurementId: "G-678SMH2ND5"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const ADMIN_PASSWORD = "emyeudang"; 

  const DOC_TO_TEAM = {
    to1: { id: "T·ªï 1", color: "#00f3ff" },
    to2: { id: "T·ªï 2", color: "#bc13fe" },
    to3: { id: "T·ªï 3", color: "#ff0055" },
    to4: { id: "T·ªï 4", color: "#00ff9d" }
  };

  const TEAMS = [
    { id: "T·ªï 1", color: "#00f3ff" },
    { id: "T·ªï 2", color: "#bc13fe" },
    { id: "T·ªï 3", color: "#ff0055" },
    { id: "T·ªï 4", color: "#00ff9d" }
  ];

  let realtimeTeams = {};
  let adminLogged = false;
  let adminLastAction = null;

  const galaxy = {
    team: null,

    init: async function() {
      // 1. Load Theme
      const savedTheme = localStorage.getItem('7a4_theme') || 'galaxy';
      this.setTheme(savedTheme);

      this.setupRealtimeListeners();
      await this.checkWeeklyResetFirestore();

      const saved = localStorage.getItem('7a4_member');
      if (saved) {
        this.team = saved;
        this.showMain();
      } else {
        this.showSelector();
      }

      this.renderRank();
    },

    selectTeam(name) {
      this.team = name;
      localStorage.setItem('7a4_member', name);
      this.showMain();
    },

    showSelector() {
      const sel = document.getElementById('selector-screen');
      const main = document.getElementById('main-app');
      if(sel) sel.style.display = 'flex';
      if(main) {
          main.classList.add('hidden');
          main.style.display = 'none';
      }
    },

    showMain() {
      const sel = document.getElementById('selector-screen');
      const main = document.getElementById('main-app');
      if(sel) sel.style.display = 'none';
      if(main) {
          main.classList.remove('hidden');
          main.style.display = 'block';
      }
      
      document.getElementById('team-tag').innerText = this.team;
      const color = TEAMS.find(t => t.id === this.team).color;
      document.getElementById('team-tag').style.background = color;
      this.renderRank();
    },

    logout() {
      localStorage.removeItem('7a4_member');
      this.team = null;
      this.showSelector();
    },

    // --- THEME SYSTEM ---
    openSettings() {
        document.getElementById('settings-modal').style.display = 'flex';
        // Highlight current
        const cur = localStorage.getItem('7a4_theme') || 'galaxy';
        document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
        if(cur === 'tet') document.querySelectorAll('.theme-btn')[1].classList.add('active');
        else document.querySelectorAll('.theme-btn')[0].classList.add('active');
    },
    closeSettings() {
        document.getElementById('settings-modal').style.display = 'none';
    },
    setTheme(name) {
        document.body.classList.remove('theme-tet');
        if (name === 'tet') {
            document.body.classList.add('theme-tet');
        }
        localStorage.setItem('7a4_theme', name);
        this.openSettings(); // refresh active state
    },

    teamToDocId(teamLabel) {
      if (!teamLabel) return null;
      const num = teamLabel.replace(/\D/g,'');
      return 'to' + num;
    },

    async addPoints(p) {
      if (!this.team) return;
      const docId = this.teamToDocId(this.team);
      if (!docId) return;

      const ref = doc(db, "teams", docId);
      try {
        const s = await getDoc(ref);
        if (!s.exists()) {
          await setDoc(ref, {
            name: DOC_TO_TEAM[docId].id,
            score: 0,
            updatedAt: Date.now()
          });
        }
        await updateDoc(ref, {
          score: increment(p),
          updatedAt: Date.now()
        });
        // Feedback handled in game check() via Toast
      } catch (e) {
        console.error("addPoints error:", e);
        this.toast("L·ªói ƒë·ªìng b·ªô ƒëi·ªÉm", "error");
      }
    },

    async ensureTeamsDocs() {
      for (const docId of Object.keys(DOC_TO_TEAM)) {
        const ref = doc(db, "teams", docId);
        const s = await getDoc(ref);
        if (!s.exists()) {
          await setDoc(ref, { name: DOC_TO_TEAM[docId].id, score: 0, updatedAt: Date.now() });
        }
      }
    },

    async adminAdjustPoints(docId, delta) {
      if (!adminLogged) {
        this.toast("C·∫ßn ƒëƒÉng nh·∫≠p Admin", "error");
        return;
      }
      const ref = doc(db, "teams", docId);
      try {
        const s = await getDoc(ref);
        if (!s.exists()) {
          await setDoc(ref, { name: DOC_TO_TEAM[docId].id, score: 0, updatedAt: Date.now() });
        }
        await updateDoc(ref, { score: increment(delta), updatedAt: Date.now() });

        adminLastAction = { type: "adjust", docId, delta };
        this.toast(`${delta>0? '+'+delta: delta} ƒëi·ªÉm (Admin)`, "success");
      } catch (e) {
        console.error(e);
        this.toast("L·ªói Admin update", "error");
      }
    },

    // Updated Toast to support types
    toast(m, type = 'info') {
      const t = document.getElementById('toast');
      t.innerText = m;
      t.className = ''; // reset classes
      t.classList.add(type); // add success/error/info
      
      t.style.opacity = '1';
      t.style.top = '80px'; // Lower slightly
      
      // Reset after 2s
      setTimeout(() => { 
          t.style.opacity = '0'; 
          t.style.top = '30px'; 
      }, 2000);
    },

    renderRank() {
      let data = [];
      if (Object.keys(realtimeTeams).length) {
        data = Object.keys(DOC_TO_TEAM).map(docId => ({
          id: DOC_TO_TEAM[docId].id,
          score: realtimeTeams[docId]?.score ?? 0,
          color: DOC_TO_TEAM[docId].color
        }));
      } else {
        data = TEAMS.map(t => ({
          ...t,
          score: parseInt(localStorage.getItem('score_' + t.id) || '0', 10)
        }));
      }

      data = data.sort((a,b) => b.score - a.score);
      const max = Math.max(...data.map(d => d.score), 10);

      // Render Dashboard List
      const list = document.getElementById('ranking-list');
      if(list) {
        list.innerHTML = data.map(d => `
          <div class="rank-item">
            <div class="rank-label"><span style="color:${d.color}">${d.id}</span><span>${d.score} XP</span></div>
            <div class="bar-outer"><div class="bar-inner" style="width:${(d.score/max)*100}%; background:${d.color}"></div></div>
          </div>
        `).join('');
      }

      // Render Mini Rank (Responsive)
      const miniList = document.getElementById('mini-rank-list');
      if (miniList) {
        miniList.innerHTML = data.map(d => `
          <div class="mini-rank-item" style="border-color:${d.color}">
            <span style="color:${d.color}">${d.id}</span>
            <span style="color:#fff">${d.score}</span>
          </div>
        `).join('');
      }

      this.renderPrevWinner();
    },

    async renderPrevWinner() {
      const prevEl = document.getElementById('prev-winner');
      try {
        const metaRef = doc(db, "meta", "weekly");
        const snap = await getDoc(metaRef);
        if (snap.exists()) {
          const data = snap.data();
          if (data && Array.isArray(data.winners) && data.winners.length) {
            if (data.winners.length === 1) {
              prevEl.innerText = `üèÜ V√¥ ƒë·ªãch tu·∫ßn tr∆∞·ªõc: ${data.winners[0]} ‚Äî ${data.maxScore} XP`;
            } else {
              prevEl.innerText = `ü§ù H√≤a tu·∫ßn tr∆∞·ªõc: ${data.winners.join(', ')} ‚Äî ${data.maxScore} XP`;
            }
            return;
          }
        }
      } catch(e) {
        console.warn("renderPrevWinner error", e);
      }
      prevEl.innerText = '';
    },

    closeGame() {
      document.getElementById('game-overlay').style.display = 'none';
    },

    applyTransition() {
      const content = document.getElementById('game-content-area');
      content.classList.remove('slide-in');
      void content.offsetWidth; 
      content.classList.add('slide-in');
    },

    toggleAdminPrompt() {
      const ok = prompt("Nh·∫≠p m·∫≠t kh·∫©u Admin:");
      if (ok === null) return;
      if (ok === ADMIN_PASSWORD) {
        adminLogged = true;
        document.getElementById('admin-panel').style.display = 'block';
        this.toast("ƒêƒÉng nh·∫≠p Admin th√†nh c√¥ng", "success");
      } else {
        alert("M·∫≠t kh·∫©u sai");
      }
    },

    logoutAdmin() {
      adminLogged = false;
      document.getElementById('admin-panel').style.display = 'none';
      this.toast("ƒê√£ ƒëƒÉng xu·∫•t Admin", "info");
    },

    async checkWeeklyResetFirestore() {
      try {
        await this.ensureTeamsDocs();

        const now = new Date();
        const reset = new Date(now);
        const day = reset.getDay(); 
        reset.setDate(now.getDate() - day);
        reset.setHours(12,0,0,0);

        if (now.getDay() === 0 && now.getHours() < 12) {
          reset.setDate(reset.getDate() - 7);
        }
        if (reset.getTime() > now.getTime()) {
          reset.setDate(reset.getDate() - 7);
        }

        const resetTime = reset.getTime();

        const metaRef = doc(db, "meta", "weekly");
        const metaSnap = await getDoc(metaRef);
        const lastReset = metaSnap.exists() ? (metaSnap.data().lastReset || 0) : 0;

        if (!lastReset || lastReset < resetTime) {
          const colSnap = await getDocs(collection(db, "teams"));
          const prevScores = {};
          colSnap.forEach(d => prevScores[d.id] = d.data().score || 0);

          const arr = Object.entries(prevScores);
          const maxScore = arr.length ? Math.max(...arr.map(a=>a[1])) : 0;
          const winners = arr.filter(a=>a[1]===maxScore).map(a=> DOC_TO_TEAM[a[0]]?.id ?? a[0]);

          const batch = writeBatch(db);

          colSnap.forEach(d => batch.update(doc(db, "teams", d.id), { score: 0, updatedAt: Date.now() }));

          batch.set(metaRef, {
            lastReset: resetTime,
            prevScores,
            winners,
            maxScore,
            updatedAt: Date.now()
          }, { merge: true });

          await batch.commit();
        }
      } catch (e) {
        console.error("checkWeeklyResetFirestore error:", e);
      }
    },

    setupRealtimeListeners() {
      try {
        onSnapshot(collection(db, "teams"), (snapshot) => {
          const tmp = {};
          snapshot.forEach(d => tmp[d.id] = d.data());
          realtimeTeams = tmp;
          this.renderRank();
        });

        onSnapshot(doc(db, "meta", "weekly"), () => {
          this.renderPrevWinner();
        });
      } catch (e) {
        console.error("setupRealtimeListeners error", e);
      }
    }
  };

  // --- GLOBAL FUNCTIONS FOR BUTTONS ---
  window.adminAdjust = function(docId, delta) {
    galaxy.adminAdjustPoints(docId, delta);
  }

  window.adminApplyInput = async function(docId){
    if (!adminLogged) {
      galaxy.toast("C·∫ßn ƒëƒÉng nh·∫≠p Admin", "error");
      return;
    }
    const input = document.getElementById("admin-point-input");
    const val = parseInt((input?.value || "").trim(), 10);
    if (!input || isNaN(val) || val === 0) {
      galaxy.toast("Nh·∫≠p s·ªë ƒëi·ªÉm h·ª£p l·ªá (kh√°c 0)", "error");
      return;
    }
    await galaxy.adminAdjustPoints(docId, val);
    input.value = "";
  }

  window.adminResetScores = async function(){
    if (!adminLogged) {
      galaxy.toast("C·∫ßn ƒëƒÉng nh·∫≠p Admin", "error");
      return;
    }
    try{
      await galaxy.ensureTeamsDocs();
      const colSnap = await getDocs(collection(db, "teams"));
      const before = {};
      colSnap.forEach(d => before[d.id] = d.data().score || 0);

      const batch = writeBatch(db);
      colSnap.forEach(d => batch.update(doc(db, "teams", d.id), { score: 0, updatedAt: Date.now() }));
      await batch.commit();

      adminLastAction = { type: "reset", before };

      galaxy.toast("ƒê√£ RESET ƒëi·ªÉm t·∫•t c·∫£ t·ªï", "success");
    }catch(e){
      console.error(e);
      galaxy.toast("L·ªói reset ƒëi·ªÉm", "error");
    }
  }

  window.adminUndo = async function(){
    if (!adminLogged) {
      galaxy.toast("C·∫ßn ƒëƒÉng nh·∫≠p Admin", "error");
      return;
    }
    if (!adminLastAction){
      galaxy.toast("Kh√¥ng c√≥ h√†nh ƒë·ªông ƒë·ªÉ ho√†n t√°c", "info");
      return;
    }

    try{
      if (adminLastAction.type === "adjust"){
        const { docId, delta } = adminLastAction;
        await galaxy.adminAdjustPoints(docId, -delta);
        adminLastAction = null;
        galaxy.toast("ƒê√£ ho√†n t√°c ƒëi·ªÅu ch·ªânh ƒëi·ªÉm", "success");
        return;
      }

      if (adminLastAction.type === "reset"){
        const before = adminLastAction.before || {};
        const batch = writeBatch(db);
        for (const docId of Object.keys(DOC_TO_TEAM)){
          const ref = doc(db, "teams", docId);
          const score = before[docId] ?? 0;
          batch.update(ref, { score, updatedAt: Date.now() });
        }
        await batch.commit();
        adminLastAction = null;
        galaxy.toast("ƒê√£ ho√†n t√°c RESET", "success");
        return;
      }
    }catch(e){
      console.error(e);
      galaxy.toast("L·ªói ho√†n t√°c", "error");
    }
  }

  const mathGame = {
    ans: 0,
    isProcessing: false,
    start() {
      document.getElementById('game-overlay').style.display = 'flex';
      document.getElementById('game-label').innerText = "MATH MISSION";
      this.generate();
    },
    generate() {
      this.isProcessing = false;
      galaxy.applyTransition();
      
      document.getElementById('q-tag').innerText = "MATH ‚Ä¢ HK2";
      
      const type = Math.floor(Math.random() * 4);
      let q = "";
      
      if (type === 0) {
        const a = Math.floor(Math.random() * 100), b = Math.floor(Math.random() * 50);
        this.ans = a + b; q = `${a} + ${b} = ?`;
      } else if (type === 1) {
        const a = Math.floor(Math.random() * 12) + 2, b = Math.floor(Math.random() * 11) + 2;
        this.ans = a * b; q = `${a} √ó ${b} = ?`;
      } else if (type === 2) {
        const x = Math.floor(Math.random() * 30), a = Math.floor(Math.random() * 20);
        this.ans = x; q = `T√¨m x: x + ${a} = ${x + a}`;
      } else {
        const b = Math.floor(Math.random() * 5) + 2, p = Math.floor(Math.random() * 2) + 2;
        this.ans = Math.pow(b, p); q = `${b}<sup>${p}</sup> = ?`;
      }
      document.getElementById('q-text').innerHTML = q;
      document.getElementById('q-action').innerHTML = `
        <input type="number" id="m-input" class="math-input" autofocus>
        <div style="display:flex; gap:10px; margin-top:6px; justify-content:center;">
          <button id="btn-m-confirm" class="btn-confirm" onclick="mathGame.check()">X√ÅC NH·∫¨N</button>
          <button class="btn-confirm small" style="background:rgba(255,255,255,0.1); border:1px solid #777; color:#ddd;" onclick="mathGame.skip()">B·ªé QUA</button>
        </div>
      `;
      const input = document.getElementById('m-input');
      if (input) input.focus();
    },
    check() {
      if (this.isProcessing) return;
      this.isProcessing = true;
      const btn = document.getElementById('btn-m-confirm');
      if (btn) btn.disabled = true;

      const val = parseInt(document.getElementById('m-input').value || '', 10);
      if (val === this.ans) {
        galaxy.toast("CH√çNH X√ÅC! +5 XP", "success");
        galaxy.addPoints(5);
        setTimeout(() => this.generate(), 800);
      } else {
        galaxy.toast("SAI R·ªíI!", "error");
        setTimeout(() => this.generate(), 1000); // Faster retry
      }
    },
    skip() {
      if (this.isProcessing) return;
      this.isProcessing = true;
      galaxy.toast("ƒê√É B·ªé QUA", "info");
      setTimeout(() => { this.isProcessing = false; this.generate(); }, 600);
    }
  };

  /* ... ENGLISH BANK (UNCHANGED) ... */
  const ENGLISH_BANK = [
    { q: "She is a very ________ designer.", a: "creative", o: ["creative", "creatively", "creation"], t: "Adj_Adv" },
    { q: "He decorated the room ________.", a: "creatively", o: ["creative", "creatively", "create"], t: "Adj_Adv" },
    { q: "You should be ________ to elderly people.", a: "polite", o: ["polite", "politely", "politeness"], t: "Adj_Adv" },
    { q: "The boy replied ________ to the teacher.", a: "rudely", o: ["rude", "rudely", "rudeness"], t: "Adj_Adv" },
    { q: "This sofa is very ________.", a: "comfortable", o: ["comfortable", "comfortably", "comfort"], t: "Adj_Adv" },
    { q: "She speaks English very ________.", a: "well", o: ["good", "well", "goodness"], t: "Adj_Adv" },
    { q: "He is a ________ student.", a: "good", o: ["well", "good", "badly"], t: "Adj_Adv" },
    { q: "The team played ________ yesterday.", a: "badly", o: ["bad", "badly", "worse"], t: "Adj_Adv" },
    { q: "She passed the exam ________.", a: "easily", o: ["easy", "easily", "easier"], t: "Adj_Adv" },
    { q: "Please be ________! The baby is sleeping.", a: "quiet", o: ["quiet", "quietly", "quite"], t: "Adj_Adv" },
    { q: "We need to measure the ________ of the triangle.", a: "angle", o: ["angel", "angle", "angry"], t: "Vocabulary" },
    { q: "My sister wants to study ________.", a: "photography", o: ["photographer", "photography", "photograph"], t: "Vocabulary" },
    { q: "The ________ asked us to smile.", a: "photographer", o: ["photography", "photographer", "photographic"], t: "Vocabulary" },
    { q: "I have a terrible ________.", a: "memory", o: ["memorize", "memory", "memorable"], t: "Vocabulary" },
    { q: "I need ________ my homework right now.", a: "to finish", o: ["finish", "to finish", "finishing"], t: "Grammar" },
    { q: "He decided ________ a new car.", a: "to buy", o: ["buy", "to buy", "buying"], t: "Grammar" },
    { q: "The cat tried to ________ the tall tree.", a: "climb up", o: ["climb up", "lie on", "sit on"], t: "Actions" },
    { q: "I ________ swim when I was five.", a: "could", o: ["can", "could", "will be able to"], t: "Ability" },
    { q: "She ________ speak three languages now.", a: "can", o: ["could", "can", "will be able to"], t: "Ability" },
    { q: "________ is it from your house to school?", a: "How far", o: ["How long", "How far", "How much"], t: "Questions" },
    { q: "________ does this shirt cost?", a: "How much", o: ["How many", "How much", "How long"], t: "Questions" },
    { q: "He won a ________ medal (1st place).", a: "gold", o: ["gold", "silver", "bronze"], t: "Vocabulary" },
    { q: "A person who wins a medal is a ________.", a: "medalist", o: ["medal", "medalist", "medaling"], t: "Vocabulary" },
    { q: "There are 7 days in a ________.", a: "week", o: ["week", "month", "year"], t: "Units" },
    { q: "1 kilometre is 1,000 ________.", a: "metres", o: ["metres", "kilos", "tons"], t: "Units" },
    { q: "The ball is in the ________ of the box.", a: "middle", o: ["middle", "front", "behind"], t: "Positions" },
    { q: "________ you go to bed, brush your teeth.", a: "Before", o: ["Before", "After", "While"], t: "Linking" },
    { q: "________ a clever girl!", a: "What", o: ["What", "How", "Which"], t: "Grammar" },
    { q: "________ clever the girl is!", a: "How", o: ["How", "What", "Where"], t: "Grammar" },
    { q: "Gold is ________ than silver.", a: "more expensive", o: ["more expensive", "expensive", "most expensive"], t: "Comparative" },
    { q: "He is the ________ student.", a: "smartest", o: ["smartest", "smarter", "smart"], t: "Superlative" },
    { q: "He looks ________ his father.", a: "like", o: ["like", "as", "same"], t: "Phrases" }
  ];

  const englishGame = {
    curr: null,
    lastIndex: -1,
    isProcessing: false,
    start() {
      document.getElementById('game-overlay').style.display = 'flex';
      document.getElementById('game-label').innerText = "ENGLISH COMMAND";
      this.generate();
    },
    generate() {
      this.isProcessing = false;
      galaxy.applyTransition();
      if (ENGLISH_BANK.length === 0) return;

      let idx = Math.floor(Math.random() * ENGLISH_BANK.length);
      let attempts = 0;
      while (idx === this.lastIndex && attempts < 10) {
        idx = Math.floor(Math.random() * ENGLISH_BANK.length);
        attempts++;
      }
      this.lastIndex = idx;
      this.curr = ENGLISH_BANK[idx];

      document.getElementById('q-text').innerText = this.curr.q;
      document.getElementById('q-tag').innerText = this.curr.t + " ‚Ä¢ HK2";

      const shuffled = [...this.curr.o].sort(() => Math.random() - 0.5);
      document.getElementById('q-action').innerHTML = `
        <div class="option-list">
          ${shuffled.map(o => `<button class="option-item" onclick="englishGame.check(this, '${o.replace(/'/g,"\\'")}')">${o}</button>`).join('')}
        </div>
        <div style="width:100%; display:flex; justify-content:center; margin-top:10px;">
          <button class="btn-confirm small" style="background:rgba(255,255,255,0.1); border:1px solid #777; color:#ddd;" onclick="englishGame.skip()">B·ªé QUA</button>
        </div>
      `;
    },
    check(btn, choice) {
      if (this.isProcessing) return;
      this.isProcessing = true;

      const allBtns = document.querySelectorAll('.option-item');
      allBtns.forEach(b => b.disabled = true);

      if (choice === this.curr.a) {
        galaxy.toast("ƒê√öNG R·ªíI! +10 XP", "success");
        galaxy.addPoints(10);
        setTimeout(() => this.generate(), 800);
      } else {
        // Show correct answer in Toast
        galaxy.toast(`SAI! ƒê√ÅP √ÅN: ${this.curr.a}`, "error");
        setTimeout(() => this.generate(), 1500);
      }
    },
    skip() {
      if (this.isProcessing) return;
      this.isProcessing = true;
      galaxy.toast("ƒê√É B·ªé QUA", "info");
      setTimeout(() => { this.isProcessing = false; this.generate(); }, 600);
    }
  };

  // Assign to window AFTER module load to ensure availability
  window.galaxy = galaxy;
  window.englishGame = englishGame;
  window.mathGame = mathGame;
  
  // Start init immediately once window loads
  window.addEventListener('load', () => galaxy.init());
</script>
</body>
</html>
