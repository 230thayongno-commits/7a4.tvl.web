<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>7A4 GALAXY COMMAND</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00f3ff;
            --secondary: #bc13fe;
            --accent: #ff0055;
            --success: #00ff9d;
            --dark-bg: #030712;
            --card-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Montserrat', sans-serif;
            background: var(--dark-bg);
            color: #fff;
            margin: 0;
            min-height: 100vh;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(0, 243, 255, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(188, 19, 254, 0.05) 0%, transparent 50%);
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes floating { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

        .animate-in { animation: fadeIn 0.5s ease forwards; }
        .slide-in { animation: slideIn 0.3s ease-out forwards; }

        /* UI Components */
        #toast {
            position: fixed; top: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95); color: #000;
            padding: 12px 25px; border-radius: 50px;
            font-weight: 800; z-index: 10000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            opacity: 0; pointer-events: none; transition: 0.3s;
        }

        /* Selector Screen */
        #selector-screen {
            position: fixed; inset: 0; background: var(--dark-bg);
            z-index: 9999; display: flex; flex-direction: column;
            justify-content: center; align-items: center; padding: 20px;
            text-align: center;
        }

        .hero-title {
            font-size: clamp(2rem, 8vw, 3.5rem); font-weight: 900;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text; color: transparent;
            margin-bottom: 10px; letter-spacing: -1px;
        }

        .team-grid {
            display: grid; grid-template-columns: repeat(2, 1fr);
            gap: 15px; width: 100%; max-width: 500px; margin-top: 40px;
        }

        .team-card {
            background: var(--card-bg); border: 1px solid var(--glass-border);
            padding: 30px 10px; border-radius: 20px; font-weight: 800;
            cursor: pointer; transition: 0.3s; text-transform: uppercase;
        }
        .team-card:hover { background: rgba(255,255,255,0.1); transform: scale(1.05); border-color: var(--primary); }

        /* App Layout */
        header {
            padding: 20px; display: flex; justify-content: space-between;
            align-items: center; 
            background: var(--dark-bg); /* ƒê√£ ƒë·ªïi t·ª´ trong su·ªët sang c√≥ m√†u */
            position: sticky; top: 0; z-index: 100;
            border-bottom: 1px solid var(--glass-border);
        }

        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }

        .rank-card {
            background: var(--card-bg); border-radius: 24px; padding: 25px;
            margin-bottom: 20px; border: 1px solid var(--glass-border);
            position: relative;
        }

        .rank-item { margin-bottom: 15px; }
        .rank-label { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: 700; font-size: 0.9rem; }
        .bar-outer { background: rgba(255,255,255,0.05); height: 14px; border-radius: 10px; overflow: hidden; }
        .bar-inner { height: 100%; border-radius: 10px; transition: width 1s cubic-bezier(0.34, 1.56, 0.64, 1); }

        .reset-notice {
            text-align: center; font-size: 0.75rem; color: #888; margin-top: 15px; font-weight: 600;
            border-top: 1px dashed rgba(255,255,255,0.1); padding-top: 10px;
        }

        .tiktok-group { display: flex; gap: 12px; margin-bottom: 30px; }
        .tiktok-link {
            flex: 1; display: flex; align-items: center; justify-content: center;
            gap: 10px; background: #000; padding: 15px; border-radius: 16px;
            text-decoration: none; color: #fff; font-weight: 800; font-size: 0.85rem;
            border: 1px solid var(--glass-border); transition: 0.3s;
        }
        .tiktok-link:hover { transform: translateY(-3px); border-color: var(--primary); }

        .mission-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .mission-card {
            background: var(--card-bg); padding: 30px; border-radius: 24px;
            border: 1px solid var(--glass-border); cursor: pointer;
            transition: 0.3s; position: relative; overflow: hidden;
            animation: floating 4s ease-in-out infinite;
        }
        .mission-card:hover { background: rgba(255,255,255,0.08); border-color: var(--primary); }
        .mission-card.locked { opacity: 0.5; cursor: not-allowed; animation: none; }

        .mission-icon { font-size: 3rem; margin-bottom: 15px; display: block; }
        .mission-name { font-size: 1.4rem; font-weight: 900; margin-bottom: 8px; color: var(--primary); }
        .mission-desc { font-size: 0.9rem; color: #aaa; line-height: 1.4; }

        .badge-soon {
            position: absolute; top: 12px; right: -30px; background: #febd23;
            color: #000; padding: 4px 35px; font-size: 0.65rem;
            font-weight: 900; transform: rotate(45deg);
        }

        /* Overlay Game */
        #game-overlay {
            position: fixed; inset: 0; background: var(--dark-bg);
            z-index: 1000; display: none; flex-direction: column; padding: 20px;
        }

        .game-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .game-content { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; max-width: 600px; margin: 0 auto; width: 100%; }
        
        .q-tag { background: rgba(0, 243, 255, 0.1); color: var(--primary); padding: 5px 15px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; margin-bottom: 15px; text-transform: uppercase; }
        .q-text { font-size: clamp(1.1rem, 4vw, 1.7rem); font-weight: 800; text-align: center; margin-bottom: 25px; line-height: 1.4; }

        .option-list { display: grid; gap: 14px; width: 100%; margin-bottom: 10px; }
        .option-item {
            background: var(--card-bg); border: 1px solid var(--glass-border);
            padding: 16px 20px; border-radius: 12px; color: #fff;
            text-align: left; font-weight: 700; font-size: 0.95rem; cursor: pointer; transition: 0.2s;
        }
        .option-item:hover { background: rgba(255,255,255,0.1); border-color: var(--primary); }
        .option-item:disabled { opacity: 0.6; cursor: not-allowed; }

        .math-input {
            background: transparent; border: none; border-bottom: 4px solid var(--primary);
            color: #fff; font-size: 3.5rem; width: 100%; text-align: center;
            font-weight: 900; outline: none; margin-bottom: 20px;
        }

        .btn-confirm {
            background: var(--primary); color: #000; width: 100%; padding: 15px 20px;
            border-radius: 12px; font-weight: 900; font-size: 1.0rem; margin-top: 10px; border: none; cursor: pointer;
        }
        .btn-confirm.small { width: auto; padding: 10px 14px; font-size: 0.9rem; border-radius: 10px; }
        .btn-confirm:disabled { background: #555; cursor: not-allowed; }

        footer {
            margin-top: 30px; padding: 30px; text-align: center;
            border-top: 1px solid var(--glass-border); color: #555; font-size: 0.8rem;
        }

        .hidden { display: none !important; }

        .update-card {
            background: rgba(255,255,255,0.03); border: 1px dashed rgba(255,255,255,0.06);
            padding: 12px 14px; border-radius: 12px; color: #ddd; font-weight: 700; margin-bottom: 18px;
        }

        /* admin panel */
        #admin-panel {
            position: fixed; right: 20px; top: 80px; background: rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.06); padding: 12px; border-radius: 10px;
            z-index: 1100; display:none; width: 220px; font-weight:700;
        }
        #admin-panel button { display:block; width:100%; margin:6px 0; }

        @media (max-width: 600px) {
            .mission-grid { grid-template-columns: 1fr; }
            .hero-title { font-size: 2.2rem; }
            .q-text { font-size: 1.2rem; }
            .option-item { padding: 12px 15px; font-size: 0.95rem; }
            .math-input { font-size: 2.4rem; }
        }
    </style>
</head>
<body>

    <div id="toast">Th√¥ng b√°o</div>

    <!-- M√ÄN H√åNH CH·ªåN T·ªî -->
    <div id="selector-screen">
        <div class="hero-title animate-in">7A4 GALAXY<br>COMMAND</div>
        <p class="animate-in" style="color: #aaa; letter-spacing: 2px; font-size: 0.75rem; font-weight: 600;">H·ªÜ TH·ªêNG √îN T·∫¨P HK2</p>
        
        <div class="team-grid animate-in" style="animation-delay: 0.2s;">
            <div class="team-card" onclick="galaxy.selectTeam('T·ªï 1')" style="color: var(--primary)">T·ªï 1</div>
            <div class="team-card" onclick="galaxy.selectTeam('T·ªï 2')" style="color: var(--secondary)">T·ªï 2</div>
            <div class="team-card" onclick="galaxy.selectTeam('T·ªï 3')" style="color: var(--accent)">T·ªï 3</div>
            <div class="team-card" onclick="galaxy.selectTeam('T·ªï 4')" style="color: var(--success)">T·ªï 4</div>
        </div>
    </div>

    <!-- APP CH√çNH -->
    <div id="main-app" class="hidden">
        <header>
            <div style="font-weight: 900; letter-spacing: 1px; font-size: 1.1rem;">7A4 COMMAND</div>
            <div id="user-info" style="display: flex; align-items: center; gap: 15px;">
                <span id="team-tag" style="font-weight: 900; background: var(--primary); color: #000; padding: 4px 12px; border-radius: 8px; font-size: 0.8rem;"></span>
                <button onclick="galaxy.logout()" style="background:none; border:none; color:#555; font-weight:bold; cursor:pointer; font-family:'Montserrat';">THO√ÅT</button>
                <button id="admin-btn" onclick="galaxy.toggleAdminPrompt()" style="background:none; border:none; color:#ddd; font-weight:700; cursor:pointer; font-family:'Montserrat';">Admin</button>
            </div>
        </header>

        <div class="container animate-in">
            <div class="rank-card">
                <h2 style="margin-top: 0; font-size: 1.1rem; text-align: center; color: var(--primary); text-transform: uppercase; letter-spacing: 2px;">ƒêi·ªÉm S·ªë Chi·∫øn ƒê·ªôi</h2>
                <div id="ranking-list"></div>
                <div id="prev-winner" style="margin-top:12px; font-weight:800; text-align:center; color:#ddd;"></div>
                <div class="reset-notice">
                    ‚è∞ H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông reset ƒëi·ªÉm v√†o m·ªói <strong>Ch·ªß nh·∫≠t 12:00</strong> (gi·ªù ƒë·ªãa ph∆∞∆°ng).
                </div>
            </div>

            <div class="update-card">
                B·∫£n c·∫≠p nh·∫≠t 1.1 ‚Äî S·ª≠a l·ªói nh·ªè, th√™m n√∫t <strong>B·ªé QUA</strong> cho Ti·∫øng Anh & To√°n, ch·ªânh s·ª≠a b·ªë c·ª•c c√¢u h·ªèi, t·ªëi ∆∞u ƒë·ªìng b·ªô ƒëi·ªÉm gi·ªØa tab.
            </div>

            <div class="tiktok-group">
                <a href="https://www.tiktok.com/@7a4.tvl.2025.2026" target="_blank" class="tiktok-link">TikTok A4 1</a>
                <a href="https://www.tiktok.com/@a4.tvl.2025.2026" target="_blank" class="tiktok-link">TikTok A4 2</a>
            </div>

            <div class="mission-grid">
                <div class="mission-card" onclick="englishGame.start()">
                    <span class="mission-icon">üá¨üáß</span>
                    <div class="mission-name">Ti·∫øng Anh HK2</div>
                    <div class="mission-desc">100+ c√¢u h·ªèi Vocabulary, Adverbs, How structure, Ability...</div>
                </div>

                <div class="mission-card" onclick="mathGame.start()">
                    <span class="mission-icon">üìê</span>
                    <div class="mission-name">To√°n H·ªçc</div>
                    <div class="mission-desc">C·ªông tr·ª´, nh√¢n chia, t√¨m x, s·ªë m≈©.</div>
                </div>

                <div class="mission-card locked">
                    <span class="badge-soon">S·∫ÆP C√ì</span>
                    <span class="mission-icon">üß™</span>
                    <div class="mission-name">KHTN</div>
                    <div class="mission-desc">H·ªá th·ªëng c√¢u h·ªèi √¥n t·∫≠p Khoa h·ªçc t·ª± nhi√™n.</div>
                </div>
            </div>

            <footer>
                *n·∫øu web c√≥ l·ªói g√¨ hay c√°c c√¢u h·ªèi sai xin li√™n h·ªá admin t·∫°i 2 trang tik tok c·ªßa l·ªõp.
            </footer>
        </div>
    </div>

    <!-- ADMIN PANEL (hidden until login) -->
    <div id="admin-panel">
        <div style="font-size:0.95rem; margin-bottom:8px;">Admin Tools (ƒë√£ ƒëƒÉng nh·∫≠p)</div>
        <div style="font-size:0.85rem; margin-bottom:6px;">ƒêi·ªÅu ch·ªânh ƒëi·ªÉm th·ªß c√¥ng:</div>
        <div style="display:flex; gap:6px; margin-bottom:6px;">
            <button onclick="adminAdjust('to1',1)" class="btn-confirm small">T+1</button>
            <button onclick="adminAdjust('to1',-1)" class="btn-confirm small">T-1</button>
        </div>
        <div style="display:flex; gap:6px; margin-bottom:6px;">
            <button onclick="adminAdjust('to2',1)" class="btn-confirm small">T+1</button>
            <button onclick="adminAdjust('to2',-1)" class="btn-confirm small">T-1</button>
        </div>
        <div style="display:flex; gap:6px; margin-bottom:6px;">
            <button onclick="adminAdjust('to3',1)" class="btn-confirm small">T+1</button>
            <button onclick="adminAdjust('to3',-1)" class="btn-confirm small">T-1</button>
        </div>
        <div style="display:flex; gap:6px; margin-bottom:8px;">
            <button onclick="adminAdjust('to4',1)" class="btn-confirm small">T+1</button>
            <button onclick="adminAdjust('to4',-1)" class="btn-confirm small">T-1</button>
        </div>
        <button onclick="galaxy.logoutAdmin()" style="background:#ff5a5a; color:#000; font-weight:900; border-radius:8px; padding:8px;">ƒêƒÉng xu·∫•t Admin</button>
    </div>

    <!-- GAME OVERLAY -->
    <div id="game-overlay">
        <div class="game-nav">
            <div id="game-label" style="font-weight: 900; color: var(--primary); letter-spacing: 2px;">MISSION</div>
            <button onclick="galaxy.closeGame()" style="background:none; border:none; color:#fff; font-size: 1.5rem; cursor:pointer;">‚úï</button>
        </div>
        <div id="game-content-area" class="game-content">
            <div id="q-tag" class="q-tag">Ki·∫øn th·ª©c HK2</div>
            <div id="q-text" class="q-text">ƒêang t·∫£i c√¢u h·ªèi...</div>
            <div id="q-action" style="width: 100%;"></div>
            <div id="q-feedback" style="margin-top: 16px; font-weight: 800; text-align: center; height: 26px;"></div>
        </div>
    </div>

<script type="module">
  /***** Firebase setup *****/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, getDocs,
    writeBatch, increment, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

  // YOUR firebaseConfig (ƒê√£ cung c·∫•p tr∆∞·ªõc)
  const firebaseConfig = {
    apiKey: "AIzaSyBtdoU4bzBVsXXvYswbUf0smAuYIq9rxlM",
    authDomain: "a4-galaxy-command.firebaseapp.com",
    projectId: "a4-galaxy-command",
    storageBucket: "a4-galaxy-command.firebasestorage.app",
    messagingSenderId: "147400399283",
    appId: "1:147400399283:web:6d470d3e02a94e01f053c6",
    measurementId: "G-678SMH2ND5"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ADMIN password (client-side): thay ƒë·ªïi n·∫øu c·∫ßn
  const ADMIN_PASSWORD = "admin123"; // <-- ƒë·ªïi m·∫≠t kh·∫©u n√†y n·∫øu mu·ªën

  // map doc ids to display names/colors (gi·ªØ gi·ªëng TEAMS)
  const DOC_TO_TEAM = {
    to1: { id: "T·ªï 1", color: "#00f3ff" },
    to2: { id: "T·ªï 2", color: "#bc13fe" },
    to3: { id: "T·ªï 3", color: "#ff0055" },
    to4: { id: "T·ªï 4", color: "#00ff9d" }
  };

  /***** END Firebase setup *****/

const TEAMS = [
    { id: "T·ªï 1", color: "#00f3ff" },
    { id: "T·ªï 2", color: "#bc13fe" },
    { id: "T·ªï 3", color: "#ff0055" },
    { id: "T·ªï 4", color: "#00ff9d" }
];

let realtimeTeams = {}; // will hold latest scores from Firestore
let adminLogged = false;

const galaxy = {
    team: null,
    init: async function() {
        // start listening teams collection realtime
        this.setupRealtimeListeners();

        // perform weekly reset if needed (uses Firestore)
        await this.checkWeeklyResetFirestore();

        const saved = localStorage.getItem('7a4_member');
        if (saved) {
            this.team = saved;
            this.showMain();
        } else {
            this.showSelector();
        }
        // initial render (will use realtimeTeams when available)
        this.renderRank();

        // keep old storage listener for compatibility (not primary)
        window.addEventListener('storage', (e) => {
            if (!e.key) return;
            if (e.key.startsWith('score_') || e.key === '7a4_last_reset' || e.key === '7a4_prev_winners') {
                this.renderRank();
            }
        });
    },
    selectTeam(name) {
        this.team = name;
        localStorage.setItem('7a4_member', name);
        this.showMain();
    },
    showSelector() {
        document.getElementById('selector-screen').style.display = 'flex';
        document.getElementById('main-app').classList.add('hidden');
        document.getElementById('main-app').style.display = 'none';
    },
    showMain() {
        document.getElementById('selector-screen').style.display = 'none';
        document.getElementById('main-app').classList.remove('hidden');
        document.getElementById('main-app').style.display = 'block';
        document.getElementById('team-tag').innerText = this.team;
        const color = TEAMS.find(t => t.id === this.team).color;
        document.getElementById('team-tag').style.background = color;
        this.renderRank();
    },
    logout() {
        localStorage.removeItem('7a4_member');
        this.team = null;
        this.showSelector();
    },

    /***** Firestore-backed addPoints *****/
    async addPoints(p) {
        // called when player answers correct in game
        if (!this.team) return;
        // map team label to doc id
        const docId = this.teamToDocId(this.team);
        if (!docId) return;

        // Increment in Firestore
        const ref = doc(db, "teams", docId);
        try {
            // ensure doc exists
            const s = await getDoc(ref);
            if (!s.exists()) {
                await setDoc(ref, {
                    name: DOC_TO_TEAM[docId].id,
                    score: 0,
                    updatedAt: Date.now()
                });
            }
            await updateDoc(ref, {
                score: increment(p),
                updatedAt: Date.now()
            });
            this.toast(`+${p} ƒêI·ªÇM!`);
        } catch (e) {
            console.error("addPoints error:", e);
            this.toast("L·ªói ƒë·ªìng b·ªô ƒëi·ªÉm");
        }
    },

    // Admin manual adjust requires adminLogged true
    async adminAdjustPoints(docId, delta) {
        if (!adminLogged) {
            this.toast("C·∫ßn ƒëƒÉng nh·∫≠p Admin");
            return;
        }
        const ref = doc(db, "teams", docId);
        try {
            const s = await getDoc(ref);
            if (!s.exists()) {
                await setDoc(ref, { name: DOC_TO_TEAM[docId].id, score: 0, updatedAt: Date.now() });
            }
            await updateDoc(ref, { score: increment(delta), updatedAt: Date.now() });
            this.toast(`${delta>0? '+'+delta: delta} ƒëi·ªÉm (Admin)`);
        } catch (e) {
            console.error(e);
            this.toast("L·ªói Admin update");
        }
    },

    toast(m) {
        const t = document.getElementById('toast');
        t.innerText = m;
        t.style.opacity = '1';
        t.style.top = '100px';
        setTimeout(() => { t.style.opacity = '0'; t.style.top = '30px'; }, 1500);
    },

    // renderRank uses realtimeTeams if available, otherwise fallback to localStorage
    renderRank() {
        const list = document.getElementById('ranking-list');

        // Build data array
        let data = [];
        if (Object.keys(realtimeTeams).length) {
            data = Object.keys(DOC_TO_TEAM).map(docId => ({
                id: DOC_TO_TEAM[docId].id,
                score: realtimeTeams[docId]?.score ?? 0,
                color: DOC_TO_TEAM[docId].color
            }));
        } else {
            // fallback to localStorage (legacy)
            data = TEAMS.map(t => ({
                ...t,
                score: parseInt(localStorage.getItem('score_' + t.id) || '0', 10)
            }));
        }

        data = data.sort((a,b) => b.score - a.score);
        const max = Math.max(...data.map(d => d.score), 10);

        list.innerHTML = data.map(d => `
            <div class="rank-item">
                <div class="rank-label"><span style="color:${d.color}">${d.id}</span><span>${d.score} XP</span></div>
                <div class="bar-outer"><div class="bar-inner" style="width:${(d.score/max)*100}%; background:${d.color}"></div></div>
            </div>
        `).join('');

        // show prev winner stored in Firestore meta if exists, else fallback to localStorage
        this.renderPrevWinner();
    },

    async renderPrevWinner() {
        const prevEl = document.getElementById('prev-winner');
        try {
            const metaRef = doc(db, "meta", "weekly");
            const snap = await getDoc(metaRef);
            if (snap.exists()) {
                const data = snap.data();
                if (data && Array.isArray(data.winners) && data.winners.length) {
                    if (data.winners.length === 1) {
                        prevEl.innerText = `üèÜ V√¥ ƒë·ªãch tu·∫ßn tr∆∞·ªõc: ${data.winners[0]} ‚Äî ${data.maxScore} XP`;
                    } else {
                        prevEl.innerText = `ü§ù H√≤a tu·∫ßn tr∆∞·ªõc: ${data.winners.join(', ')} ‚Äî ${data.maxScore} XP`;
                    }
                    return;
                }
            }
        } catch(e) {
            console.warn("renderPrevWinner error", e);
        }

        // fallback to localStorage
        const prev = localStorage.getItem('7a4_prev_winners');
        const prevScores = JSON.parse(localStorage.getItem('7a4_prev_scores') || '{}');
        if (prev) {
            try {
                const obj = JSON.parse(prev);
                if (obj && Array.isArray(obj.winners) && obj.winners.length) {
                    if (obj.winners.length === 1) {
                        prevEl.innerText = `üèÜ V√¥ ƒë·ªãch tu·∫ßn tr∆∞·ªõc: ${obj.winners[0]} ‚Äî ${obj.maxScore} XP`;
                    } else {
                        prevEl.innerText = `ü§ù H√≤a tu·∫ßn tr∆∞·ªõc: ${obj.winners.join(', ')} ‚Äî ${obj.maxScore} XP`;
                    }
                    return;
                }
            } catch(e) {}
        } else if (Object.keys(prevScores).length) {
            const arr = Object.entries(prevScores);
            if (arr.length) {
                const maxScore = Math.max(...arr.map(a=>a[1]));
                const winners = arr.filter(a=>a[1]===maxScore).map(a=>a[0]);
                if (winners.length === 1) prevEl.innerText = `üèÜ V√¥ ƒë·ªãch tu·∫ßn tr∆∞·ªõc: ${winners[0]} ‚Äî ${maxScore} XP`;
                else prevEl.innerText = `ü§ù H√≤a tu·∫ßn tr∆∞·ªõc: ${winners.join(', ')} ‚Äî ${maxScore} XP`;
                return;
            }
        }
        prevEl.innerText = '';
    },

    closeGame() {
        document.getElementById('game-overlay').style.display = 'none';
    },
    applyTransition() {
        const content = document.getElementById('game-content-area');
        content.classList.remove('slide-in');
        void content.offsetWidth; 
        content.classList.add('slide-in');
    },

    teamToDocId(teamLabel) {
        // convert "T·ªï 1" -> to1
        if (!teamLabel) return null;
        const num = teamLabel.replace(/\D/g,'');
        return 'to' + num;
    },

    // Admin helpers
    toggleAdminPrompt() {
        const ok = prompt("Nh·∫≠p m·∫≠t kh·∫©u Admin:");
        if (ok === null) return;
        if (ok === ADMIN_PASSWORD) {
            adminLogged = true;
            document.getElementById('admin-panel').style.display = 'block';
            this.toast("ƒêƒÉng nh·∫≠p Admin th√†nh c√¥ng");
        } else {
            alert("M·∫≠t kh·∫©u sai");
        }
    },
    logoutAdmin() {
        adminLogged = false;
        document.getElementById('admin-panel').style.display = 'none';
        this.toast("ƒê√£ ƒëƒÉng xu·∫•t Admin");
    },

    /***** Weekly reset in Firestore *****/
    async checkWeeklyResetFirestore() {
        try {
            // compute scheduledReset (Sunday 12:00 local) same logic as before
            const now = new Date();
            const sundayThis = new Date(now);
            const day = sundayThis.getDay(); // 0=Sunday
            sundayThis.setDate(now.getDate() - day);
            sundayThis.setHours(12,0,0,0);

            let scheduledReset;
            if (now >= sundayThis) scheduledReset = sundayThis;
            else scheduledReset = new Date(sundayThis.getTime() - 7 * 24 * 60 * 60 * 1000);

            const metaRef = doc(db, "meta", "weekly");
            const metaSnap = await getDoc(metaRef);
            const lastReset = metaSnap.exists() ? (metaSnap.data().lastReset || 0) : 0;

            if (!lastReset || lastReset < scheduledReset.getTime()) {
                // get current team scores
                const colSnap = await getDocs(collection(db, "teams"));
                const prevScores = {};
                colSnap.forEach(d => {
                    prevScores[d.id] = d.data().score || 0;
                });

                // compute winners
                const arr = Object.entries(prevScores);
                const maxScore = arr.length ? Math.max(...arr.map(a=>a[1])) : 0;
                const winners = arr.filter(a=>a[1]===maxScore).map(a=> DOC_TO_TEAM[a[0]]?.id ?? a[0]);

                // batch reset scores to 0
                const batch = writeBatch(db);
                colSnap.forEach(d => {
                    const ref = doc(db, "teams", d.id);
                    batch.update(ref, { score: 0, updatedAt: Date.now() });
                });
                // update meta doc: lastReset, prevScores, prevWinners
                batch.set(metaRef, {
                    lastReset: scheduledReset.getTime(),
                    prevScores,
                    winners,
                    maxScore,
                    updatedAt: Date.now()
                }, { merge: true });

                await batch.commit();
            }
        } catch (e) {
            console.error("checkWeeklyResetFirestore error:", e);
        }
    },

    /***** realtime listeners for teams collection *****/
    setupRealtimeListeners() {
        try {
            const teamsCol = collection(db, "teams");
            onSnapshot(teamsCol, (snapshot) => {
                const tmp = {};
                snapshot.forEach(d => {
                    tmp[d.id] = d.data();
                });
                realtimeTeams = tmp;
                this.renderRank();
            });

            // also listen meta/weekly to update prev winner realtime
            const metaRef = doc(db, "meta", "weekly");
            onSnapshot(metaRef, (snap) => {
                this.renderPrevWinner();
            });
        } catch (e) {
            console.error("setupRealtimeListeners error", e);
        }
    }
};

function adminAdjust(docId, delta) {
    galaxy.adminAdjustPoints(docId, delta);
}

/***** mathGame, englishGame remain as original but call galaxy.addPoints (which now syncs to Firestore) *****/

const mathGame = {
    ans: 0,
    isProcessing: false, // NgƒÉn ch·ªçn nhi·ªÅu l·∫ßn
    start() {
        document.getElementById('game-overlay').style.display = 'flex';
        document.getElementById('game-label').innerText = "MATH MISSION";
        this.generate();
    },
    generate() {
        this.isProcessing = false;
        galaxy.applyTransition();
        const type = Math.floor(Math.random() * 4);
        let q = "";
        document.getElementById('q-feedback').innerText = "";
        if (type === 0) {
            const a = Math.floor(Math.random() * 100), b = Math.floor(Math.random() * 50);
            this.ans = a + b; q = `${a} + ${b} = ?`;
        } else if (type === 1) {
            const a = Math.floor(Math.random() * 12) + 2, b = Math.floor(Math.random() * 11) + 2;
            this.ans = a * b; q = `${a} √ó ${b} = ?`;
        } else if (type === 2) {
            const x = Math.floor(Math.random() * 30), a = Math.floor(Math.random() * 20);
            this.ans = x; q = `T√¨m x: x + ${a} = ${x + a}`;
        } else {
            const b = Math.floor(Math.random() * 5) + 2, p = Math.floor(Math.random() * 2) + 2;
            this.ans = Math.pow(b, p); q = `${b}<sup>${p}</sup> = ?`;
        }
        document.getElementById('q-text').innerHTML = q;
        document.getElementById('q-action').innerHTML = `
            <input type="number" id="m-input" class="math-input" autofocus>
            <div style="display:flex; gap:10px; margin-top:6px;">
                <button id="btn-m-confirm" class="btn-confirm" onclick="mathGame.check()">X√ÅC NH·∫¨N</button>
                <button class="btn-confirm small" style="background:#555;" onclick="mathGame.skip()">B·ªé QUA</button>
            </div>
        `;
        const input = document.getElementById('m-input');
        if (input) input.focus();
    },
    check() {
        if (this.isProcessing) return;
        this.isProcessing = true;
        const btn = document.getElementById('btn-m-confirm');
        if (btn) btn.disabled = true;

        const val = parseInt(document.getElementById('m-input').value || '', 10);
        if (val === this.ans) {
            document.getElementById('q-feedback').innerText = "CH√çNH X√ÅC! +5 XP";
            document.getElementById('q-feedback').style.color = "var(--success)";
            // award points to team (will sync to Firestore)
            galaxy.addPoints(5);
            setTimeout(() => this.generate(), 800);
        } else {
            document.getElementById('q-feedback').innerText = "SAI R·ªíI!";
            document.getElementById('q-feedback').style.color = "var(--accent)";
            setTimeout(() => this.generate(), 1500);
        }
    },
    skip() {
        if (this.isProcessing) return;
        this.isProcessing = true;
        document.getElementById('q-feedback').innerText = "ƒê√É B·ªé QUA";
        document.getElementById('q-feedback').style.color = "#ddd";
        setTimeout(() => { this.isProcessing = false; this.generate(); }, 600);
    }
};

const ENGLISH_BANK = [
    { q: "The little boy tried to ________ the wall to get the ball.", a: "climb up", o: ["lie on", "climb up", "sit on"], t: "Actions" },
    { q: "Be careful! Don't ________ on the bed, you might break it.", a: "jump up", o: ["jump up", "stand in", "walk on"], t: "Actions" },
    { q: "She likes to ________ the grass and look at the sky.", a: "lie on", o: ["climb up", "lie on", "jump up"], t: "Actions" },
    { q: "Please ________ the line and wait for your turn.", a: "stand in", o: ["stand in", "walk on", "sit on"], t: "Actions" },
    { q: "You should not ________ the fragile bridge.", a: "walk on", o: ["lie on", "walk on", "jump up"], t: "Actions" },
    { q: "He decided to ________ the chair because he was tired.", a: "sit on", o: ["sit on", "climb up", "stand in"], t: "Actions" },
    { q: "I have a very clear ________ of my first day at school.", a: "memory", o: ["memorize", "memorable", "memory"], t: "Memory" },
    { q: "That summer holiday was truly ________.", a: "memorable", o: ["memorable", "memory", "memorize"], t: "Memory" },
    { q: "You need to ________ these new words for the test tomorrow.", a: "memorize", o: ["memory", "memorize", "memorable"], t: "Memory" },
    { q: "They are going to ________ next month after two years of dating.", a: "get married", o: ["get married", "arrive for", "decide to"], t: "Events" },
    { q: "We ________ the party just as the music started.", a: "arrived for", o: ["decided to", "arrived for", "memorized"], t: "Events" },
    { q: "The ________ was the highlight of the celebration.", a: "firework display", o: ["memory", "firework display", "photography"], t: "Events" },
    { q: "I ________ study harder to pass the exam.", a: "decide to", o: ["decide to", "will", "Photography"], t: "Future" },
    { q: "He is a professional ________; he takes beautiful photos.", a: "photographer", o: ["photography", "photographer", "creative"], t: "Art" },
    { q: "________ is her favorite hobby.", a: "Photography", o: ["Photography", "Photographer", "Polite"], t: "Art" },
    { q: "It is very ________ to see snow in this tropical city.", a: "unusual", o: ["unusual", "comfortable", "easy"], t: "Adj" },
    { q: "You should ________ before entering someone's room.", a: "ask for permission", o: ["need to", "ask for permission", "be beautiful"], t: "Etiquette" },
    { q: "An ________ is a shape formed by two lines.", a: "angle", o: ["angle", "angel", "unusual"], t: "Math terms" },
    { q: "She is a very ________ person; she always has new ideas.", a: "creative", o: ["rude", "creative", "quiet"], t: "Adj" },
    { q: "The bed is very ________, so I slept well.", a: "comfortable", o: ["comfortable", "bad", "easy"], t: "Adj" },
    { q: "He solved the difficult problem ________.", a: "easily", o: ["easy", "easily"], t: "Adverbs" },
    { q: "The children are playing ________ in their room.", a: "quietly", o: ["quiet", "quietly"], t: "Adverbs" },
    { q: "She speaks ________ to everyone she meets.", a: "politely", o: ["polite", "politely"], t: "Adverbs" },
    { q: "He behaved ________ at the party yesterday.", a: "rudely", o: ["rude", "rudely"], t: "Adverbs" },
    { q: "They designed the room ________.", a: "creatively", o: ["creative", "creatively"], t: "Adverbs" },
    { q: "I can sit ________ in this armchair for hours.", a: "comfortably", o: ["comfortable", "comfortably"], t: "Adverbs" },
    { q: "She plays the piano very ________.", a: "well", o: ["good", "well"], t: "Adverbs" },
    { q: "He did ________ on his test because he didn't study.", a: "badly", o: ["bad", "badly"], t: "Adverbs" },
    { q: "The teacher asked us to sit ________.", a: "quietly", o: ["quiet", "quietly"], t: "Adverbs" },
    { q: "Everything was organized ________.", a: "politely", o: ["polite", "politely"], t: "Adverbs" },
    { q: "'________ is it from your house to school?' - 'About 2 km.'", a: "How far", o: ["How long", "How far", "How many"], t: "How structure" },
    { q: "'________ apples do you want?'", a: "How many", o: ["How much", "How often", "How many"], t: "How structure" },
    { q: "'________ is this shirt?' - 'It's 20 dollars.'", a: "How much", o: ["How many", "How much", "How far"], t: "How structure" },
    { q: "'________ do you go to the gym?' - 'Three times a week.'", a: "How often", o: ["How long", "How often", "How old"], t: "How structure" },
    { q: "'________ have you lived here?' - 'For ten years.'", a: "How long", o: ["How far", "How long", "How high"], t: "How structure" },
    { q: "'________ is that building?' - 'It's 50 meters.'", a: "How tall", o: ["How tall", "How long", "How many"], t: "How structure" },
    { q: "'________ is the Everest mountain?'", a: "How high", o: ["How tall", "How high", "How far"], t: "How structure" },
    { q: "'________ are you?' - 'I'm 15.'", a: "How old", o: ["How old", "How much", "How often"], t: "How structure" },
    { q: "'How old are you?' can be rewritten as: 'What is your ________?'", a: "age", o: ["year", "age", "old"], t: "Rewrite" },
    { q: "'How far is it from A to B?' means: 'What is the ________ between A and B?'", a: "distance", o: ["length", "distance", "height"], t: "Rewrite" },
    { q: "'How long is it?' means: 'What is the ________ of it?'", a: "length", o: ["length", "height", "distance"], t: "Rewrite" },
    { q: "'How high is it?' means: 'What is the ________ of it?'", a: "height", o: ["age", "height", "length"], t: "Rewrite" },
    { q: "Now, I ________ speak English quite well.", a: "can", o: ["can", "could", "will be able to"], t: "Ability" },
    { q: "When he was five, he ________ play the violin.", a: "could", o: ["can", "could", "will be able to"], t: "Ability" },
    { q: "In the future, robots ________ do all the housework.", a: "will be able to", o: ["can", "could", "will be able to"], t: "Ability" },
    { q: "She ________ swim when she was a baby.", a: "couldn't", o: ["couldn't", "can't", "won't be able to"], t: "Ability" },
    { q: "I ________ come to the party tomorrow because I'm busy.", a: "won't be able to", o: ["can't", "couldn't", "won't be able to"], t: "Ability" },
    { q: "________ you help me with this heavy box, please?", a: "Can", o: ["Can", "Could", "Will be able to"], t: "Ability" },
    { q: "They ________ finish the project on time last week.", a: "couldn't", o: ["can't", "couldn't", "won't be able to"], t: "Ability" },
    { q: "With enough practice, you ________ speak fluently.", a: "will be able to", o: ["can", "could", "will be able to"], t: "Ability" },
    { q: "She ________. (To be + Adj)", a: "is beautiful", o: ["is beautiful", "beautiful is", "is beautifully"], t: "Grammar" },
    { q: "He is a ________ boy. (Adj + N)", a: "polite", o: ["politely", "polite", "rudely"], t: "Grammar" },
    { q: "You ________ finish your homework before going out.", a: "need to", o: ["be adj", "need to", "photography"], t: "Grammar" },
    { q: "It is ________ to sit on this chair.", a: "comfortable", o: ["comfortably", "comfortable", "comfort"], t: "Grammar" },
    { q: "An ________ is different from an angle.", a: "angel", o: ["angel", "creative", "unusual"], t: "Vocabulary" },
    { q: "The photographer ________ the camera carefully.", a: "picked up", o: ["stand in", "climb up", "picked up"], t: "Vocabulary" },
    { q: "In the past, people ________ use smartphones.", a: "couldn't", o: ["can't", "couldn't", "won't be able to"], t: "Grammar" },
    { q: "I ________ go to the park yesterday.", a: "decided to", o: ["arrive for", "walk on", "decided to"], t: "Grammar" },
    { q: "Please be ________ in the library.", a: "quiet", o: ["quietly", "quiet", "rude"], t: "Grammar" },
    { q: "The firework display was very ________.", a: "unusual", o: ["unusual", "badly", "rudely"], t: "Grammar" },
    { q: "Odd one out: A. Climb up B. Jump up C. Memory", a: "Memory", o: ["Climb up", "Jump up", "Memory"], t: "Odd one out" },
    { q: "Odd one out: A. Easily B. Well C. Good", a: "Good", o: ["Easily", "Well", "Good"], t: "Odd one out" },
    { q: "Odd one out: A. Photographer B. Photography C. Beautiful", a: "Beautiful", o: ["Photographer", "Photography", "Beautiful"], t: "Odd one out" },
    { q: "Odd one out: A. How far B. How often C. How age", a: "How age", o: ["How far", "How often", "How age"], t: "Odd one out" },
    { q: "Odd one out: A. Can B. Could C. Need to", a: "Need to", o: ["Can", "Could", "Need to"], t: "Odd one out" },
    { q: "Odd one out: A. Angel B. Angle C. Unusual", a: "Unusual", o: ["Angel", "Angle", "Unusual"], t: "Odd one out" },
    { q: "Odd one out: A. Rude B. Polite C. Creatively", a: "Creatively", o: ["Rude", "Polite", "Creatively"], t: "Odd one out" },
    { q: "Odd one out: A. Stand in B. Sit on C. Firework", a: "Firework", o: ["Stand in", "Sit on", "Firework"], t: "Odd one out" },
    { q: "Odd one out: A. Memorize B. Memorable C. Memory", a: "Memory", o: ["Memorize", "Memorable", "Memory"], t: "Odd one out" },
    { q: "Odd one out: A. Height B. Tall C. High", a: "Height", o: ["Height", "Tall", "High"], t: "Odd one out" },
    { q: "Find mistake: She (A) is (B) a (C) beautifully girl.", a: "beautifully", o: ["is", "a", "beautifully"], t: "Mistake" },
    { q: "Find mistake: He (A) can (B) speaks English (C) well.", a: "speaks", o: ["can", "speaks", "well"], t: "Mistake" },
    { q: "Find mistake: I (A) decided (B) to (C) getting married.", a: "getting", o: ["decided", "to", "getting"], t: "Mistake" },
    { q: "Find mistake: How (A) much (B) is the (C) distance?", a: "much", o: ["much", "is the", "distance"], t: "Mistake" },
    { q: "Find mistake: He (A) runs (B) very (C) good.", a: "good", o: ["runs", "very", "good"], t: "Mistake" },
    { q: "Find mistake: They (A) arrived (B) for the (C) party late.", a: "for the", o: ["arrived", "for the", "party late"], t: "Mistake" },
    { q: "Find mistake: We (A) need (B) to (C) be politely.", a: "politely", o: ["need", "to", "politely"], t: "Mistake" },
    { q: "Find mistake: The (A) angel of the (B) triangle is (C) 90 degrees.", a: "angel", o: ["angel", "triangle", "90 degrees"], t: "Mistake" },
    { q: "Find mistake: Last (A) year, I (B) can (C) swim.", a: "can", o: ["year", "can", "swim"], t: "Mistake" },
    { q: "Find mistake: It (A) is (B) a (C) memorable memory.", a: "memorable", o: ["is", "a", "memorable"], t: "Mistake" },
    { q: "I use ________ words to order events.", a: "sequencing", o: ["sequencing", "memory", "creative"], t: "Terms" },
    { q: "I can talk about ________ (smart kids).", a: "prodigies", o: ["photographers", "prodigies", "angels"], t: "Terms" },
    { q: "The lesson is about ________ (the past).", a: "In the Past", o: ["Achieve", "In the Past", "Ability"], t: "Terms" },
    { q: "We can ________ (events in the park).", a: "order", o: ["order", "memorize", "climb"], t: "Terms" },
    { q: "Writing ________ is important.", a: "Lesson 6", o: ["Lesson 6", "Lesson 5", "Vocabulary"], t: "Terms" },
    { q: "Adjectives describe ________.", a: "nouns", o: ["verbs", "nouns", "adverbs"], t: "Grammar" },
    { q: "Adverbs describe ________.", a: "verbs", o: ["nouns", "verbs", "adjectives"], t: "Grammar" },
    { q: " 'Well' is the adverb of ________.", a: "good", o: ["bad", "good"], t: "Grammar" },
    { q: " 'Easily' ends with ________.", a: "-ily", o: ["-ly", "-y", "-ily"], t: "Grammar" },
    { q: " 'Comfortably' is an ________.", a: "adverb", o: ["adjective", "adverb"], t: "Grammar" }
];

const englishGame = {
    curr: null,
    lastIndex: -1,
    isProcessing: false, // NgƒÉn ch·ªçn nhi·ªÅu l·∫ßn
    start() {
        document.getElementById('game-overlay').style.display = 'flex';
        document.getElementById('game-label').innerText = "ENGLISH COMMAND";
        this.generate();
    },
    generate() {
        this.isProcessing = false;
        galaxy.applyTransition();
        // ngƒÉn l·∫∑p 2 c√¢u li√™n ti·∫øp: ch·ªçn index kh√°c lastIndex
        if (ENGLISH_BANK.length === 0) return;
        let idx = Math.floor(Math.random() * ENGLISH_BANK.length);
        let attempts = 0;
        while (idx === this.lastIndex && attempts < 10) {
            idx = Math.floor(Math.random() * ENGLISH_BANK.length);
            attempts++;
        }
        this.lastIndex = idx;
        this.curr = ENGLISH_BANK[idx];
        document.getElementById('q-feedback').innerText = "";
        // Hi·ªÉn th·ªã c√¢u h·ªèi v√† tag
        document.getElementById('q-text').innerText = this.curr.q;
        document.getElementById('q-tag').innerText = this.curr.t + " ‚Ä¢ HK2";
        // shuffle options
        const shuffled = [...this.curr.o].sort(() => Math.random() - 0.5);
        document.getElementById('q-action').innerHTML = `
            <div class="option-list">
                ${shuffled.map(o => `<button class="option-item" onclick="englishGame.check(this, '${o.replace(/'/g,"\\'")}')">${o}</button>`).join('')}
            </div>
            <div style="width:100%; display:flex; justify-content:center; margin-top:10px;">
                <button class="btn-confirm small" style="background:#555;" onclick="englishGame.skip()">B·ªé QUA</button>
            </div>
        `;
    },
    check(btn, choice) {
        if (this.isProcessing) return;
        this.isProcessing = true;
        
        // V√¥ hi·ªáu h√≥a t·∫•t c·∫£ c√°c n√∫t ngay l·∫≠p t·ª©c
        const allBtns = document.querySelectorAll('.option-item');
        allBtns.forEach(b => b.disabled = true);

        if (choice === this.curr.a) {
            document.getElementById('q-feedback').innerText = "ƒê√öNG R·ªíI! +10 XP";
            document.getElementById('q-feedback').style.color = "var(--success)";
            galaxy.addPoints(10);
            setTimeout(() => this.generate(), 800);
        } else {
            document.getElementById('q-feedback').innerText = `SAI! ƒê√ÅP √ÅN: ${this.curr.a}`;
            document.getElementById('q-feedback').style.color = "var(--accent)";
            setTimeout(() => this.generate(), 2000);
        }
    },
    skip() {
        if (this.isProcessing) return;
        this.isProcessing = true;
        document.getElementById('q-feedback').innerText = "ƒê√É B·ªé QUA";
        document.getElementById('q-feedback').style.color = "#ddd";
        setTimeout(() => { this.isProcessing = false; this.generate(); }, 600);
    }
}

window.onload = () => galaxy.init();
</script>
</body>
</html>
