<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>7A4 COMMAND</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        :root{
            --primary: #00f3ff;
            --secondary: #bc13fe;
            --accent: #ff0055;
            --success: #00ff9d;

            --glass: rgba(255,255,255,0.06);
            --glass-border: rgba(255,255,255,0.12);

            --bg1: #05060b;
            --bg2: #0a0f1f;

            --text: #eaeaea;
        }

        /* =========================
           THEME SWITCH SYSTEM
        ========================== */
        body[data-theme="galaxy"]{
            --primary: #00f3ff;
            --secondary: #bc13fe;
            --accent: #ff0055;
            --success: #00ff9d;
            --bg1: #05060b;
            --bg2: #0a0f1f;
            --glass: rgba(255,255,255,0.06);
            --glass-border: rgba(255,255,255,0.12);
            --text: #eaeaea;
        }

        /* üéâ T·∫æT THEME (NEW) */
        body[data-theme="tet"]{
            --primary: #ffcc33;      /* v√†ng */
            --secondary: #ff4d4d;    /* ƒë·ªè */
            --accent: #ff2d8a;       /* h·ªìng */
            --success: #4dff88;      /* xanh */
            --bg1: #1a0606;
            --bg2: #2a0b0b;
            --glass: rgba(255,255,255,0.08);
            --glass-border: rgba(255,255,255,0.16);
            --text: #fff3d6;
        }

        body{
            margin:0;
            font-family:'Montserrat', sans-serif;
            background: radial-gradient(circle at top, var(--bg2), var(--bg1));
            color: var(--text);
            overflow-x:hidden;
        }

        /* ===== Toast ===== */
        #toast{
            position:fixed;
            top:18px;
            left:50%;
            transform:translateX(-50%);
            background:rgba(0,0,0,0.75);
            border:1px solid rgba(255,255,255,0.18);
            padding:12px 18px;
            border-radius:14px;
            font-weight:800;
            letter-spacing:0.5px;
            z-index:99999;
            opacity:0;
            pointer-events:none;
            transition:0.25s;
            backdrop-filter: blur(10px);
        }
        #toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }

        /* ===== Animations ===== */
        .animate-in{
            animation:fadeUp 0.7s ease both;
        }
        @keyframes fadeUp{
            from{ opacity:0; transform:translateY(12px); }
            to{ opacity:1; transform:translateY(0); }
        }

        /* ===== Selector Screen ===== */
        #selector-screen{
            position:fixed;
            inset:0;
            display:flex;
            flex-direction:column;
            justify-content:center;
            align-items:center;
            gap:18px;
            z-index:10; /* FIX click issue */
            padding:20px;
        }

        .hero-title{
            font-weight:900;
            letter-spacing:2px;
            font-size:2.7rem;
            text-align:center;
            line-height:1.05;
            color: var(--primary);
            text-shadow: 0 0 18px rgba(0,0,0,0.6);
        }

        .team-grid{
            width:100%;
            max-width:520px;
            display:grid;
            grid-template-columns:repeat(2, 1fr);
            gap:12px;
        }
        .team-card{
            background:var(--glass);
            border:1px solid var(--glass-border);
            border-radius:18px;
            padding:16px;
            text-align:center;
            font-weight:900;
            cursor:pointer;
            user-select:none;
            transition:0.2s;
            backdrop-filter: blur(12px);
            z-index:11; /* ensure clickable */
            position:relative;
        }
        .team-card:hover{ transform: translateY(-2px); }

        /* ===== Main App ===== */
        #main-app{
            min-height:100vh;
        }
        header{
            position:sticky;
            top:0;
            z-index:20;
            display:flex;
            justify-content:space-between;
            align-items:center;
            padding:16px 18px;
            background:rgba(0,0,0,0.35);
            border-bottom:1px solid rgba(255,255,255,0.08);
            backdrop-filter: blur(10px);
        }

        .container{
            max-width:980px;
            margin:0 auto;
            padding:18px;
        }

        .rank-card{
            background:var(--glass);
            border:1px solid var(--glass-border);
            border-radius:22px;
            padding:18px;
            backdrop-filter: blur(14px);
            box-shadow: 0 18px 50px rgba(0,0,0,0.25);
        }

        .update-card{
            margin-top:14px;
            background:rgba(255,255,255,0.05);
            border:1px dashed rgba(255,255,255,0.12);
            border-radius:18px;
            padding:14px;
            font-weight:700;
            color:#ddd;
        }

        .tiktok-group{
            display:flex;
            gap:10px;
            justify-content:center;
            flex-wrap:wrap;
            margin-top:14px;
        }
        .tiktok-link{
            text-decoration:none;
            color:#000;
            font-weight:900;
            padding:10px 14px;
            border-radius:14px;
            background:linear-gradient(135deg, var(--primary), var(--secondary));
            box-shadow:0 10px 25px rgba(0,0,0,0.25);
        }

        .mission-grid{
            margin-top:16px;
            display:grid;
            grid-template-columns:repeat(3, 1fr);
            gap:14px;
        }
        .mission-card{
            background:var(--glass);
            border:1px solid var(--glass-border);
            border-radius:22px;
            padding:16px;
            cursor:pointer;
            transition:0.2s;
            position:relative;
            overflow:hidden;
            backdrop-filter: blur(14px);
        }
        .mission-card:hover{ transform:translateY(-3px); }
        .mission-icon{ font-size:2rem; display:block; margin-bottom:8px; }
        .mission-name{ font-weight:900; font-size:1.05rem; }
        .mission-desc{ color:#bbb; font-weight:600; font-size:0.85rem; margin-top:4px; line-height:1.4; }

        .locked{ opacity:0.55; cursor:not-allowed; }
        .badge-soon{
            position:absolute;
            top:12px;
            right:12px;
            background:rgba(0,0,0,0.55);
            border:1px solid rgba(255,255,255,0.18);
            padding:6px 10px;
            border-radius:999px;
            font-weight:900;
            font-size:0.75rem;
        }

        /* ===== Buttons ===== */
        .btn-confirm{
            width:100%;
            border:none;
            padding:14px 16px;
            border-radius:16px;
            font-weight:900;
            letter-spacing:1px;
            cursor:pointer;
            background:rgba(0, 243, 255, 0.16);
            color:var(--primary);
            border:1px solid rgba(0,243,255,0.35);
            box-shadow: 0 4px 15px rgba(0, 243, 255, 0.3);
            transition: 0.3s;
            font-family:'Montserrat', sans-serif;
        }
        .btn-confirm:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 243, 255, 0.5); }
        .btn-confirm.small { width: auto; padding: 12px 18px; font-size: 0.9rem; border-radius: 12px; box-shadow: none; }
        .btn-confirm:disabled { background: #555; cursor: not-allowed; box-shadow: none; transform: none; }

        footer{
            margin-top:30px;
            padding:30px;
            text-align:center;
            border-top:1px solid var(--glass-border);
            color:#555;
            font-size:0.8rem;
        }
        .hidden{ display:none !important; }

        /* ===== Game Overlay ===== */
        #game-overlay{
            position:fixed;
            inset:0;
            display:none;
            flex-direction:column;
            background:rgba(0,0,0,0.72);
            z-index:9999;
            backdrop-filter: blur(10px);
        }
        .game-header{
            display:flex;
            justify-content:space-between;
            align-items:center;
            padding:16px 18px;
            border-bottom:1px solid rgba(255,255,255,0.1);
        }
        .btn-exit{
            border:none;
            cursor:pointer;
            border-radius:14px;
            padding:10px 14px;
            font-weight:900;
            background:rgba(255,255,255,0.08);
            color:#fff;
            border:1px solid rgba(255,255,255,0.12);
            font-family:'Montserrat', sans-serif;
        }
        .game-container-box{
            flex:1;
            display:flex;
            flex-direction:column;
            gap:12px;
            padding:16px;
            max-width:820px;
            width:100%;
            margin:0 auto;
        }

        /* ===== Mini Scoreboard in Game (FIX responsive) ===== */
        .mini-rank-grid{
            display:grid;
            grid-template-columns: repeat(2, 1fr);
            gap:10px;
        }
        .mini-rank-item{
            display:flex;
            justify-content:space-between;
            align-items:center;
            padding:10px 12px;
            border-radius:16px;
            background:rgba(255,255,255,0.06);
            border:1px solid rgba(255,255,255,0.10);
            font-weight:900;
            font-size:0.9rem;
        }
        .mini-rank-item span:last-child{
            font-weight:900;
            opacity:0.95;
        }

        .question-card{
            background:var(--glass);
            border:1px solid var(--glass-border);
            border-radius:24px;
            padding:18px;
            backdrop-filter: blur(14px);
            box-shadow: 0 18px 50px rgba(0,0,0,0.25);
        }
        .q-tag{
            display:inline-block;
            padding:8px 12px;
            border-radius:999px;
            font-weight:900;
            background:rgba(0,0,0,0.35);
            border:1px solid rgba(255,255,255,0.12);
            margin-bottom:12px;
            font-size:0.8rem;
            letter-spacing:1px;
        }
        .q-text{
            font-size:1.35rem; /* slight improvement */
            font-weight:900;
            text-align:center;
            line-height:1.35;
            margin:6px 0 14px;
            color: var(--text);
        }

        .option-list{
            display:grid;
            gap:10px;
        }
        .option-item{
            width:100%;
            padding:14px 16px;
            border-radius:18px;
            border:1px solid rgba(255,255,255,0.12);
            background:rgba(255,255,255,0.06);
            color:#fff;
            font-weight:900;
            cursor:pointer;
            transition:0.2s;
            font-family:'Montserrat', sans-serif;
        }
        .option-item:hover{ transform:translateY(-2px); }
        .option-item:disabled{ opacity:0.55; cursor:not-allowed; transform:none; }

        .math-input{
            width:100%;
            text-align:center;
            font-size:2.7rem;
            font-weight:900;
            border-radius:20px;
            padding:12px;
            border:1px solid rgba(255,255,255,0.16);
            background:rgba(0,0,0,0.25);
            color:#fff;
            outline:none;
            font-family:'Montserrat', sans-serif;
        }

        /* ===== Settings Overlay ===== */
        #style-overlay{
            position:fixed;
            inset:0;
            display:none;
            align-items:center;
            justify-content:center;
            background:rgba(0,0,0,0.65);
            z-index:99998;
            backdrop-filter: blur(10px);
            padding:16px;
        }
        .style-modal{
            width:min(520px, 100%);
            border-radius:24px;
            padding:18px;
            background:rgba(10,10,10,0.72);
            border:1px solid rgba(255,255,255,0.14);
            box-shadow:0 30px 90px rgba(0,0,0,0.45);
        }
        .style-title{
            font-weight:900;
            letter-spacing:1px;
            font-size:1.1rem;
            margin-bottom:12px;
            color:var(--primary);
            text-transform:uppercase;
        }
        .style-grid{
            display:grid;
            grid-template-columns:1fr 1fr;
            gap:12px;
        }
        .style-card{
            border-radius:20px;
            padding:14px;
            cursor:pointer;
            border:1px solid rgba(255,255,255,0.12);
            background:rgba(255,255,255,0.06);
            transition:0.2s;
            user-select:none;
        }
        .style-card:hover{ transform:translateY(-2px); }
        .style-name{ font-weight:900; margin-bottom:6px; }
        .style-desc{ font-size:0.82rem; font-weight:700; color:#bbb; line-height:1.35; }
        .style-actions{
            display:flex;
            justify-content:flex-end;
            gap:10px;
            margin-top:14px;
        }

        /* ===== Mobile ===== */
        @media (max-width: 600px){
            .mission-grid{ grid-template-columns:1fr; }
            .hero-title{ font-size:2.2rem; }
            .q-text{ font-size:1.2rem; }
            .option-item{ padding:14px 15px; font-size:0.95rem; }
            .math-input{ font-size:2.4rem; }

            header{ padding:14px; }
            #user-info{ gap:10px !important; }
            #admin-btn{ padding:8px 10px; border-radius:10px; background: rgba(255,255,255,0.06); }
            header button{ padding:8px 10px; border-radius:10px; }

            /* FIX: mini rank mobile */
            .mini-rank-grid{
                grid-template-columns:1fr;
                gap:8px;
            }
            .mini-rank-item{
                font-size:0.85rem;
                padding:10px 12px;
            }

            .style-grid{ grid-template-columns:1fr; }
        }
    </style>
</head>
<body data-theme="galaxy">

    <div id="toast">Th√¥ng b√°o</div>

    <!-- M√ÄN H√åNH CH·ªåN T·ªî -->
    <div id="selector-screen">
        <div class="hero-title animate-in">7A4 GALAXY<br>COMMAND</div>
        <p class="animate-in" style="color: #aaa; letter-spacing: 2px; font-size: 0.75rem; font-weight: 600;">H·ªÜ TH·ªêNG √îN T·∫¨P HK2</p>

        <div class="team-grid animate-in" style="animation-delay: 0.2s;">
            <div class="team-card" onclick="galaxy.selectTeam('T·ªï 1')" style="color: var(--primary)">T·ªï 1</div>
            <div class="team-card" onclick="galaxy.selectTeam('T·ªï 2')" style="color: var(--secondary)">T·ªï 2</div>
            <div class="team-card" onclick="galaxy.selectTeam('T·ªï 3')" style="color: var(--accent)">T·ªï 3</div>
            <div class="team-card" onclick="galaxy.selectTeam('T·ªï 4')" style="color: var(--success)">T·ªï 4</div>
        </div>
    </div>

    <!-- APP CH√çNH -->
    <div id="main-app" class="hidden">
        <header>
            <div style="font-weight: 900; letter-spacing: 1px; font-size: 1.1rem;">7A4 COMMAND</div>
            <div id="user-info" style="display: flex; align-items: center; gap: 15px;">
                <span id="team-tag" style="font-weight: 900; background: var(--primary); color: #000; padding: 4px 12px; border-radius: 8px; font-size: 0.8rem;"></span>

                <!-- NEW: Settings Button -->
                <button onclick="galaxy.openStyleSettings()" style="background:none; border:none; color:#ddd; font-weight:800; cursor:pointer; font-family:'Montserrat';">
                    üé® Style
                </button>

                <button onclick="galaxy.logout()" style="background:none; border:none; color:#555; font-weight:bold; cursor:pointer; font-family:'Montserrat';">THO√ÅT</button>
                <button id="admin-btn" onclick="galaxy.toggleAdminPrompt()" style="background:none; border:none; color:#ddd; font-weight:700; cursor:pointer; font-family:'Montserrat';">Admin</button>
            </div>
        </header>

        <div class="container animate-in">
            <div class="rank-card">
                <h2 style="margin-top: 0; font-size: 1.1rem; text-align: center; color: var(--primary); text-transform: uppercase; letter-spacing: 2px;">ƒêi·ªÉm S·ªë Chi·∫øn ƒê·ªôi</h2>
                <div id="ranking-list"></div>
                <div id="prev-winner" style="margin-top:12px; font-weight:800; text-align:center; color:#ddd;"></div>
                <div class="reset-notice" style="margin-top:12px; color:#aaa; font-weight:700; font-size:0.85rem; text-align:center;">
                    ‚è∞ H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông reset ƒëi·ªÉm v√†o m·ªói <strong>Ch·ªß nh·∫≠t 12:00</strong> (gi·ªù ƒë·ªãa ph∆∞∆°ng).
                </div>
            </div>

            <div class="update-card">
                B·∫£n c·∫≠p nh·∫≠t 1.2 ‚Äî <strong>T·ªëi ∆∞u Admin Panel</strong>, giao di·ªán Game m·ªõi hi·ªán ƒë·∫°i h∆°n.
            </div>

            <div class="tiktok-group">
                <a href="https://www.tiktok.com/@7a4.tvl.2025.2026" target="_blank" class="tiktok-link">TikTok A4 1</a>
                <a href="https://www.tiktok.com/@a4.tvl.2025.2026" target="_blank" class="tiktok-link">TikTok A4 2</a>
            </div>

            <div class="mission-grid">
                <div class="mission-card" onclick="englishGame.start()">
                    <span class="mission-icon">üá¨üáß</span>
                    <div class="mission-name">Ti·∫øng Anh HK2</div>
                    <div class="mission-desc">100+ c√¢u h·ªèi Vocabulary, Adverbs, How structure, Ability.</div>
                </div>

                <div class="mission-card" onclick="mathGame.start()">
                    <span class="mission-icon">üìê</span>
                    <div class="mission-name">To√°n H·ªçc</div>
                    <div class="mission-desc">C·ªông tr·ª´, nh√¢n chia, t√¨m x, s·ªë m≈©.</div>
                </div>

                <div class="mission-card locked">
                    <span class="badge-soon">S·∫ÆP C√ì</span>
                    <span class="mission-icon">üß™</span>
                    <div class="mission-name">KHTN</div>
                    <div class="mission-desc">H·ªá th·ªëng c√¢u h·ªèi √¥n t·∫≠p Khoa h·ªçc t·ª± nhi√™n.</div>
                </div>
            </div>

            <footer>
                *n·∫øu web c√≥ l·ªói g√¨ hay c√°c c√¢u h·ªèi sai xin li√™n h·ªá admin t·∫°i 2 trang tik tok c·ªßa l·ªõp.
            </footer>
        </div>
    </div>

    <!-- SETTINGS OVERLAY -->
    <div id="style-overlay">
        <div class="style-modal">
            <div class="style-title">C√†i ƒë·∫∑t phong c√°ch game</div>

            <div class="style-grid">
                <div class="style-card" onclick="galaxy.setTheme('galaxy')">
                    <div class="style-name">üåå Galaxy</div>
                    <div class="style-desc">Phong c√°ch c≈©: neon, v≈© tr·ª•, √°nh s√°ng l·∫°nh.</div>
                </div>

                <div class="style-card" onclick="galaxy.setTheme('tet')">
                    <div class="style-name">üßß T·∫øt</div>
                    <div class="style-desc">Thi·∫øt k·∫ø m·ªõi: ƒë·ªè - v√†ng, kh√¥ng kh√≠ T·∫øt r·ª±c r·ª°.</div>
                </div>
            </div>

            <div class="style-actions">
                <button class="btn-confirm small" style="background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.14); color:#fff;" onclick="galaxy.closeStyleSettings()">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- ADMIN PANEL (gi·ªØ nguy√™n code c·ªßa b·∫°n - kh√¥ng s·ª≠a menu admin) -->
    <div id="admin-panel"></div>

    <!-- GAME OVERLAY -->
    <div id="game-overlay">
        <div class="game-header">
            <div id="game-label" style="font-weight: 900; color: var(--primary); letter-spacing: 2px; font-size: 1.2rem;">MISSION</div>
            <button class="btn-exit" onclick="galaxy.closeGame()">
                <span>THO√ÅT</span> ‚úï
            </button>
        </div>

        <div class="game-container-box">
            <div id="mini-rank-list" class="mini-rank-grid"></div>

            <div class="question-card">
                <div id="q-tag" class="q-tag">Ki·∫øn th·ª©c HK2</div>
                <div id="game-content-area" style="width: 100%; display:flex; flex-direction:column; align-items:center;">
                    <div id="q-text" class="q-text">ƒêang t·∫£i c√¢u h·ªèi.</div>
                    <div id="q-action" style="width: 100%;"></div>
                </div>

                <!-- NOTE: gi·ªØ nh∆∞ng kh√¥ng d√πng ƒë·ªÉ b√°o skip/sai n·ªØa -->
                <div id="q-feedback" style="margin-top: 18px; font-weight: 800; text-align: center; height: 26px; font-size: 1.05rem;"></div>
            </div>
        </div>
    </div>

<script type="module">
  /***** Firebase setup *****/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, getDocs,
    writeBatch, increment
  } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBtdoU4bzBVsXXvYswbUf0smAuYIq9rxlM",
    authDomain: "a4-galaxy-command.firebaseapp.com",
    projectId: "a4-galaxy-command",
    storageBucket: "a4-galaxy-command.firebasestorage.app",
    messagingSenderId: "147400399283",
    appId: "1:147400399283:web:6d470d3e02a94e01f053c6",
    measurementId: "G-678SMH2ND5"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const ADMIN_PASSWORD = "emyeudang"; 

  const DOC_TO_TEAM = {
    to1: { id: "T·ªï 1", color: "#00f3ff" },
    to2: { id: "T·ªï 2", color: "#bc13fe" },
    to3: { id: "T·ªï 3", color: "#ff0055" },
    to4: { id: "T·ªï 4", color: "#00ff9d" }
  };

  const TEAMS = [
    { id: "T·ªï 1", color: "#00f3ff" },
    { id: "T·ªï 2", color: "#bc13fe" },
    { id: "T·ªï 3", color: "#ff0055" },
    { id: "T·ªï 4", color: "#00ff9d" }
  ];

  let realtimeTeams = {};
  let adminLogged = false;
  let adminLastAction = null;

  const galaxy = {
    team: null,

    init: async function() {
      // Load saved theme
      const savedTheme = localStorage.getItem("7a4_theme") || "galaxy";
      document.body.setAttribute("data-theme", savedTheme);

      this.setupRealtimeListeners();
      await this.checkWeeklyResetFirestore();

      const saved = localStorage.getItem('7a4_member');
      if (saved) {
        this.team = saved;
        this.showMain();
      } else {
        this.showSelector();
      }

      this.renderRank();

      window.addEventListener('storage', (e) => {
        if (!e.key) return;
        if (e.key.startsWith('score_') || e.key === '7a4_last_reset' || e.key === '7a4_prev_winners') {
          this.renderRank();
        }
      });
    },

    /* ===== Theme Settings ===== */
    openStyleSettings(){
      document.getElementById("style-overlay").style.display = "flex";
    },
    closeStyleSettings(){
      document.getElementById("style-overlay").style.display = "none";
    },
    setTheme(theme){
      document.body.setAttribute("data-theme", theme);
      localStorage.setItem("7a4_theme", theme);
      this.toast("ƒê√£ ƒë·ªïi phong c√°ch: " + (theme === "tet" ? "T·∫øt" : "Galaxy"));
    },

    selectTeam(name) {
      this.team = name;
      localStorage.setItem('7a4_member', name);
      this.showMain();
    },

    showSelector() {
      document.getElementById('selector-screen').style.display = 'flex';
      document.getElementById('main-app').classList.add('hidden');
      document.getElementById('main-app').style.display = 'none';
    },

    showMain() {
      document.getElementById('selector-screen').style.display = 'none';
      document.getElementById('main-app').classList.remove('hidden');
      document.getElementById('main-app').style.display = 'block';
      document.getElementById('team-tag').innerText = this.team;
      const color = TEAMS.find(t => t.id === this.team).color;
      document.getElementById('team-tag').style.background = color;
      this.renderRank();
    },

    logout() {
      localStorage.removeItem('7a4_member');
      this.team = null;
      this.showSelector();
    },

    teamToDocId(teamLabel) {
      if (!teamLabel) return null;
      const num = teamLabel.replace(/\D/g,'');
      return 'to' + num;
    },

    toast(msg){
      const t = document.getElementById("toast");
      t.innerText = msg;
      t.classList.add("show");
      clearTimeout(this._toastTimer);
      this._toastTimer = setTimeout(()=> t.classList.remove("show"), 1800);
    },

    applyTransition(){ /* gi·ªØ nguy√™n n·∫øu b·∫°n c√≥ */ },

    closeGame(){
      document.getElementById('game-overlay').style.display = 'none';
      document.getElementById('q-feedback').innerText = "";
    },

    /* ===== RANK RENDER ===== */
    renderRank(){
      // main rank
      const list = document.getElementById("ranking-list");
      if (!list) return;

      const items = Object.keys(DOC_TO_TEAM).map(docId=>{
        const t = DOC_TO_TEAM[docId];
        const score = realtimeTeams[docId]?.score ?? 0;
        return { docId, name: t.id, color: t.color, score };
      }).sort((a,b)=> b.score - a.score);

      list.innerHTML = items.map((it, idx)=>`
        <div style="
          display:flex; justify-content:space-between; align-items:center;
          padding:12px 14px; border-radius:16px;
          background:rgba(255,255,255,0.05);
          border:1px solid rgba(255,255,255,0.10);
          margin-top:10px;
          font-weight:900;">
          <div style="display:flex; align-items:center; gap:10px;">
            <div style="width:34px; height:34px; border-radius:12px; display:flex; align-items:center; justify-content:center;
              background:rgba(0,0,0,0.35); border:1px solid rgba(255,255,255,0.10);">
              ${idx+1}
            </div>
            <span style="color:${it.color}">${it.name}</span>
          </div>
          <span style="font-size:1.05rem;">${it.score}</span>
        </div>
      `).join("");

      // mini rank in game
      const mini = document.getElementById("mini-rank-list");
      if (mini){
        mini.innerHTML = items.map(it=>`
          <div class="mini-rank-item">
            <span style="color:${it.color}">${it.name}</span>
            <span>${it.score}</span>
          </div>
        `).join("");
      }

      this.renderPrevWinner();
    },

    renderPrevWinner(){
      const el = document.getElementById("prev-winner");
      if (!el) return;
      // gi·ªØ nguy√™n n·∫øu b·∫°n ƒë√£ c√≥ logic meta weekly
    },

    /* ===== Firebase points ===== */
    async addPoints(p) {
      if (!this.team) return;
      const docId = this.teamToDocId(this.team);
      if (!docId) return;

      const ref = doc(db, "teams", docId);
      try {
        const s = await getDoc(ref);
        if (!s.exists()) {
          await setDoc(ref, {
            name: DOC_TO_TEAM[docId].id,
            score: 0,
            updatedAt: Date.now()
          });
        }
        await updateDoc(ref, {
          score: increment(p),
          updatedAt: Date.now()
        });
        this.toast(`+${p} ƒêI·ªÇM!`);
      } catch (e) {
        console.error("addPoints error:", e);
        this.toast("L·ªói ƒë·ªìng b·ªô ƒëi·ªÉm");
      }
    },

    async ensureTeamsDocs() {
      for (const docId of Object.keys(DOC_TO_TEAM)) {
        const ref = doc(db, "teams", docId);
        const s = await getDoc(ref);
        if (!s.exists()) {
          await setDoc(ref, { name: DOC_TO_TEAM[docId].id, score: 0, updatedAt: Date.now() });
        }
      }
    },

    async adminAdjustPoints(docId, delta) {
      if (!adminLogged) {
        this.toast("C·∫ßn ƒëƒÉng nh·∫≠p Admin");
        return;
      }
      const ref = doc(db, "teams", docId);
      try {
        const s = await getDoc(ref);
        if (!s.exists()) {
          await setDoc(ref, { name: DOC_TO_TEAM[docId].id, score: 0, updatedAt: Date.now() });
        }
        await updateDoc(ref, { score: increment(delta), updatedAt: Date.now() });
        adminLastAction = { type: "adjust", docId, delta };
        this.toast((delta>0?"+":"") + delta + " ƒëi·ªÉm");
      } catch (e) {
        console.error("adminAdjustPoints error:", e);
        this.toast("L·ªói admin");
      }
    },

    toggleAdminPrompt(){ /* gi·ªØ nguy√™n n·∫øu b·∫°n c√≥ */ },
    logoutAdmin(){ /* gi·ªØ nguy√™n n·∫øu b·∫°n c√≥ */ },

    async checkWeeklyResetFirestore() {
      try {
        // gi·ªØ nguy√™n logic reset c·ªßa b·∫°n
        const now = new Date();
        const reset = new Date();
        reset.setHours(12, 0, 0, 0);

        // Sunday = 0
        const day = reset.getDay();
        reset.setDate(reset.getDate() - day);

        if (reset.getTime() > now.getTime()) {
          reset.setDate(reset.getDate() - 7);
        }

        const resetTime = reset.getTime();

        const metaRef = doc(db, "meta", "weekly");
        const metaSnap = await getDoc(metaRef);
        const lastReset = metaSnap.exists() ? (metaSnap.data().lastReset || 0) : 0;

        if (!lastReset || lastReset < resetTime) {
          const colSnap = await getDocs(collection(db, "teams"));
          const prevScores = {};
          colSnap.forEach(d => prevScores[d.id] = d.data().score || 0);

          const arr = Object.entries(prevScores);
          const maxScore = arr.length ? Math.max(...arr.map(a=>a[1])) : 0;
          const winners = arr.filter(a=>a[1]===maxScore).map(a=> DOC_TO_TEAM[a[0]]?.id ?? a[0]);

          const batch = writeBatch(db);
          colSnap.forEach(d => batch.update(doc(db, "teams", d.id), { score: 0, updatedAt: Date.now() }));

          batch.set(metaRef, {
            lastReset: resetTime,
            prevScores,
            winners,
            maxScore,
            updatedAt: Date.now()
          }, { merge: true });

          await batch.commit();
        }
      } catch (e) {
        console.error("checkWeeklyResetFirestore error:", e);
      }
    },

    setupRealtimeListeners() {
      try {
        onSnapshot(collection(db, "teams"), (snapshot) => {
          const tmp = {};
          snapshot.forEach(d => tmp[d.id] = d.data());
          realtimeTeams = tmp;
          this.renderRank();
        });

        onSnapshot(doc(db, "meta", "weekly"), () => {
          this.renderPrevWinner();
        });
      } catch (e) {
        console.error("setupRealtimeListeners error", e);
      }
    }
  };

  function adminAdjust(docId, delta) {
    galaxy.adminAdjustPoints(docId, delta);
  }

  async function adminApplyInput(docId){
    if (!adminLogged) {
      galaxy.toast("C·∫ßn ƒëƒÉng nh·∫≠p Admin");
      return;
    }
    const input = document.getElementById("admin-point-input");
    const val = parseInt((input?.value || "").trim(), 10);
    if (!input || isNaN(val) || val === 0) {
      galaxy.toast("Nh·∫≠p s·ªë ƒëi·ªÉm h·ª£p l·ªá (kh√°c 0)");
      return;
    }
    await galaxy.adminAdjustPoints(docId, val);
    input.value = "";
  }

  async function adminResetScores(){
    if (!adminLogged) {
      galaxy.toast("C·∫ßn ƒëƒÉng nh·∫≠p Admin");
      return;
    }
    try{
      await galaxy.ensureTeamsDocs();
      const colSnap = await getDocs(collection(db, "teams"));
      const before = {};
      colSnap.forEach(d => before[d.id] = d.data().score || 0);

      const batch = writeBatch(db);
      colSnap.forEach(d => batch.update(doc(db, "teams", d.id), { score: 0, updatedAt: Date.now() }));
      await batch.commit();

      adminLastAction = { type: "reset", before };
      galaxy.toast("ƒê√£ RESET ƒëi·ªÉm t·∫•t c·∫£ t·ªï");
    }catch(e){
      console.error(e);
      galaxy.toast("L·ªói reset ƒëi·ªÉm");
    }
  }

  async function adminUndo(){
    if (!adminLogged) {
      galaxy.toast("C·∫ßn ƒëƒÉng nh·∫≠p Admin");
      return;
    }
    if (!adminLastAction){
      galaxy.toast("Kh√¥ng c√≥ h√†nh ƒë·ªông ƒë·ªÉ ho√†n t√°c");
      return;
    }

    try{
      if (adminLastAction.type === "adjust"){
        const { docId, delta } = adminLastAction;
        await galaxy.adminAdjustPoints(docId, -delta);
        adminLastAction = null;
        galaxy.toast("ƒê√£ ho√†n t√°c ƒëi·ªÅu ch·ªânh ƒëi·ªÉm");
        return;
      }

      if (adminLastAction.type === "reset"){
        const before = adminLastAction.before || {};
        const batch = writeBatch(db);
        for (const docId of Object.keys(DOC_TO_TEAM)){
          const ref = doc(db, "teams", docId);
          const score = before[docId] ?? 0;
          batch.update(ref, { score, updatedAt: Date.now() });
        }
        await batch.commit();
        adminLastAction = null;
        galaxy.toast("ƒê√£ ho√†n t√°c RESET");
        return;
      }
    }catch(e){
      console.error(e);
      galaxy.toast("L·ªói ho√†n t√°c");
    }
  }

  /* =========================
     GAME: MATH (CH·ªà S·ª¨A TH√îNG B√ÅO)
  ========================== */
  const mathGame = {
    ans: 0,
    isProcessing: false,
    start() {
      document.getElementById('game-overlay').style.display = 'flex';
      document.getElementById('game-label').innerText = "MATH MISSION";
      galaxy.renderRank(); // ensure mini rank updated
      this.generate();
    },
    generate() {
      this.isProcessing = false;
      galaxy.applyTransition();

      document.getElementById('q-tag').innerText = "MATH ‚Ä¢ HK2";

      const type = Math.floor(Math.random() * 4);
      let q = "";
      document.getElementById('q-feedback').innerText = "";

      if (type === 0) {
        const a = Math.floor(Math.random() * 100), b = Math.floor(Math.random() * 50);
        this.ans = a + b; q = `${a} + ${b} = ?`;
      } else if (type === 1) {
        const a = Math.floor(Math.random() * 12) + 2, b = Math.floor(Math.random() * 11) + 2;
        this.ans = a * b; q = `${a} √ó ${b} = ?`;
      } else if (type === 2) {
        const x = Math.floor(Math.random() * 30), a = Math.floor(Math.random() * 20);
        this.ans = x; q = `T√¨m x: x + ${a} = ${x + a}`;
      } else {
        const b = Math.floor(Math.random() * 5) + 2, p = Math.floor(Math.random() * 2) + 2;
        this.ans = Math.pow(b, p); q = `${b}<sup>${p}</sup> = ?`;
      }

      document.getElementById('q-text').innerHTML = q;
      document.getElementById('q-action').innerHTML = `
        <input type="number" id="m-input" class="math-input" autofocus>
        <div style="display:flex; gap:10px; margin-top:8px; justify-content:center;">
          <button id="btn-m-confirm" class="btn-confirm" onclick="mathGame.check()">X√ÅC NH·∫¨N</button>
          <button class="btn-confirm small" style="background:rgba(255,255,255,0.1); border:1px solid #777;" onclick="mathGame.skip()">B·ªé QUA</button>
        </div>
      `;
      const input = document.getElementById('m-input');
      if (input) input.focus();
    },
    check() {
      if (this.isProcessing) return;
      this.isProcessing = true;
      const btn = document.getElementById('btn-m-confirm');
      if (btn) btn.disabled = true;

      const val = parseInt(document.getElementById('m-input').value || '', 10);
      if (val === this.ans) {
        document.getElementById('q-feedback').innerText = "";
        galaxy.toast("CH√çNH X√ÅC! +5 XP");
        galaxy.addPoints(5);
        setTimeout(() => this.generate(), 700);
      } else {
        document.getElementById('q-feedback').innerText = "";
        galaxy.toast("SAI R·ªíI!");
        setTimeout(() => this.generate(), 1100);
      }
    },
    skip() {
      if (this.isProcessing) return;
      this.isProcessing = true;
      document.getElementById('q-feedback').innerText = "";
      galaxy.toast("ƒê√É B·ªé QUA");
      setTimeout(() => { this.isProcessing = false; this.generate(); }, 650);
    }
  };

  /* =========================
     GAME: ENGLISH (FIX l·ªói shuffle + s·ª≠a th√¥ng b√°o)
  ========================== */
  const ENGLISH_BANK = [
    { q: "She is a very ________ designer. She always has new ideas.", a: "creative", o: ["creative", "creatively", "creation"], t: "Adj_Adv" },
    { q: "He decorated the room ________ for the party.", a: "creatively", o: ["creative", "creatively", "create"], t: "Adj_Adv" },
    { q: "You should be ________ when speaking to elderly people.", a: "polite", o: ["polite", "politely", "politeness"], t: "Adj_Adv" },
    { q: "The boy replied ________ to the teacher and got into trouble.", a: "rudely", o: ["rude", "rudely", "rudeness"], t: "Adj_Adv" },
    { q: "It was ________ of him to ignore my question.", a: "rude", o: ["rude", "rudely", "rudest"], t: "Adj_Adv" },
    { q: "If you don't know the meaning of a word, you can guess it from the ________.", a: "context", o: ["context", "medal", "ton"], t: "Reading" }
  ];

  const englishGame = {
    curr: null,
    lastIndex: -1,
    isProcessing: false,
    start() {
      document.getElementById('game-overlay').style.display = 'flex';
      document.getElementById('game-label').innerText = "ENGLISH COMMAND";
      galaxy.renderRank();
      this.generate();
    },
    generate() {
      this.isProcessing = false;
      galaxy.applyTransition();
      if (ENGLISH_BANK.length === 0) return;

      let idx = Math.floor(Math.random() * ENGLISH_BANK.length);
      let attempts = 0;
      while (idx === this.lastIndex && attempts < 10) {
        idx = Math.floor(Math.random() * ENGLISH_BANK.length);
        attempts++;
      }
      this.lastIndex = idx;
      this.curr = ENGLISH_BANK[idx];

      document.getElementById('q-feedback').innerText = "";
      document.getElementById('q-text').innerText = this.curr.q;
      document.getElementById('q-tag').innerText = this.curr.t + " ‚Ä¢ HK2";

      // ‚úÖ FIX BUG: was `[.this.curr.o]` -> should be `[...this.curr.o]`
      const shuffled = [...this.curr.o].sort(() => Math.random() - 0.5);

      document.getElementById('q-action').innerHTML = `
        <div class="option-list">
          ${shuffled.map(o => `<button class="option-item" onclick="englishGame.check(this, '${o.replace(/'/g,"\\'")}')">${o}</button>`).join('')}
        </div>
        <div style="width:100%; display:flex; justify-content:center; margin-top:10px;">
          <button class="btn-confirm small" style="background:rgba(255,255,255,0.1); border:1px solid #777;" onclick="englishGame.skip()">B·ªé QUA</button>
        </div>
      `;
    },
    check(btn, choice) {
      if (this.isProcessing) return;
      this.isProcessing = true;

      const allBtns = document.querySelectorAll('.option-item');
      allBtns.forEach(b => b.disabled = true);

      if (choice === this.curr.a) {
        document.getElementById('q-feedback').innerText = "";
        galaxy.toast("ƒê√öNG R·ªíI! +10 XP");
        galaxy.addPoints(10);
        setTimeout(() => this.generate(), 750);
      } else {
        document.getElementById('q-feedback').innerText = "";
        galaxy.toast(`SAI! ƒê√ÅP √ÅN: ${this.curr.a}`);
        setTimeout(() => this.generate(), 1500);
      }
    },
    skip() {
      if (this.isProcessing) return;
      this.isProcessing = true;
      document.getElementById('q-feedback').innerText = "";
      galaxy.toast("ƒê√É B·ªé QUA");
      setTimeout(() => { this.isProcessing = false; this.generate(); }, 650);
    }
  };

  window.galaxy = galaxy;
  window.englishGame = englishGame;
  window.mathGame = mathGame;
  window.adminAdjust = adminAdjust;
  window.adminApplyInput = adminApplyInput;
  window.adminResetScores = adminResetScores;
  window.adminUndo = adminUndo;

  window.onload = () => galaxy.init();
</script>
</body>
</html>

